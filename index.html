<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PLD Helper</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Optional ES6 polyfills are intentionally omitted to avoid render-blocking external dependencies. -->
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!-- Style for Responsive Design -->
   <style>

    * {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
    }

    .safe-mode-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      z-index: 999999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease-in-out;
    }

    .safe-mode-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .safe-mode-content {
      color: white;
      text-align: center;
      font-family: 'Courier New', 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
      font-size: 24px;
      position: relative;
    }

    .safe-mode-loader {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin: 30px auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Safe Mode Status */
    .safe-mode-status {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: #00ff00;
      padding: 8px 16px;
      border-radius: 4px;
      font-family: 'Courier New', 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      z-index: 100000;
      display: none;
    }

    .safe-mode-status.visible {
      display: block;
    }

       .recovery-mode-status {
         position: fixed;
         top: calc(env(safe-area-inset-top, 0px) + 12px);
         right: 12px;
         background: rgba(122, 28, 28, 0.92);
         color: #ffe7e7;
         border: 1px solid rgba(255, 180, 180, 0.4);
         border-radius: 10px;
         padding: 8px 12px;
         font-size: 12px;
         font-weight: 600;
         z-index: 190000;
         display: none;
         max-width: min(88vw, 320px);
         box-shadow: 0 12px 26px rgba(0, 0, 0, 0.35);
       }

       .recovery-mode-status.visible {
         display: block;
       }

    /* Safe Mode Confirmation Dialog */
    .safe-mode-dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 100001;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .safe-mode-dialog.active {
      opacity: 1;
      pointer-events: all;
    }

    .dialog-content {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .dialog-content h3 {
      color: #fff;
      margin-top: 0;
      font-family: 'Inter', sans-serif;
    }

    .dialog-content p {
      color: #ccc;
      margin: 15px 0;
    }

    .dialog-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .dialog-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }

    .dialog-btn.yes {
      background: #4ade80;
      color: #000;
    }

    .dialog-btn.no {
      background: #444;
      color: #fff;
    }

    .dialog-btn.yes:hover {
      background: #3cd270;
      transform: translateY(-2px);
    }

    .dialog-btn.no:hover {
      background: #555;
      transform: translateY(-2px);
    }

    /* Terminal Option for Safe Mode */
    .terminal-option.safe-mode {
      background: #2a2a2a;
      border-color: #00ff00;
      color: #00ff00;
    }

    .terminal-option.safe-mode:hover {
      background: #3a3a3a;
    }

    .terminal-option.test-mode {
      background: #222d3f;
      border-color: #4f8cff;
      color: #c3d8ff;
    }

    .terminal-option.test-mode:hover {
      background: #2b3950;
    }


    :root {
        --motion-ease-standard: cubic-bezier(0.22, 1, 0.36, 1);
        --motion-ease-spring: cubic-bezier(0.16, 1, 0.3, 1);
        --motion-duration-fast: 220ms;
        --motion-duration-medium: 420ms;
    }

    .motion-full .glass-card,
    .motion-full .menu-item-large,
    .motion-full .pref-card,
    .motion-full .btn-primary,
    .motion-full .btn-small,
    .motion-full .btn-settings-toggle,
    .motion-full .nav-link,
    .motion-full .terminal-option {
        transition:
            transform var(--motion-duration-fast) var(--motion-ease-standard),
            box-shadow var(--motion-duration-fast) var(--motion-ease-standard),
            background-color var(--motion-duration-fast) var(--motion-ease-standard),
            border-color var(--motion-duration-fast) var(--motion-ease-standard),
            opacity var(--motion-duration-fast) ease;
        will-change: transform, opacity;
    }

    .motion-full .glass-card:hover,
    .motion-full .menu-item-large:hover,
    .motion-full .pref-card:hover {
        transform: translateY(-3px) scale(1.01);
        box-shadow: 0 18px 35px rgba(0, 0, 0, 0.22);
    }

    .motion-full .btn-primary:hover,
    .motion-full .btn-small:hover,
    .motion-full .btn-settings-toggle:hover,
    .motion-full .terminal-option:hover,
    .motion-full .nav-link:hover {
        transform: translateY(-2px) scale(1.02);
    }

    .motion-full .btn-primary:active,
    .motion-full .btn-small:active,
    .motion-full .btn-settings-toggle:active,
    .motion-full .terminal-option:active,
    .motion-full .nav-link:active {
        transform: scale(0.97);
    }

    .motion-full .glass-card:focus-within,
    .motion-full .btn-primary:focus-visible,
    .motion-full .btn-small:focus-visible,
    .motion-full .btn-settings-toggle:focus-visible,
    .motion-full .nav-link:focus-visible,
    .motion-full .terminal-option:focus-visible {
        box-shadow: 0 0 0 3px rgba(140, 180, 255, 0.35), 0 12px 28px rgba(0, 0, 0, 0.24);
    }

    .motion-full .tab-content {
        transition: opacity var(--motion-duration-medium) var(--motion-ease-standard),
                    transform var(--motion-duration-medium) var(--motion-ease-standard);
    }

    .motion-full .tab-content.hidden {
        transform: translateY(10px);
    }

    body.motion-full::before {
        content: '';
        position: fixed;
        inset: -14%;
        pointer-events: none;
        z-index: -1;
        background:
            radial-gradient(circle at calc(var(--parallax-x, 50%) * 1%) calc(var(--parallax-y, 50%) * 1%), rgba(120, 165, 255, 0.14), transparent 55%),
            radial-gradient(circle at calc(100% - (var(--parallax-x, 50%) * 0.8%)) calc(100% - (var(--parallax-y, 50%) * 0.8%)), rgba(177, 123, 255, 0.12), transparent 52%);
        transform: translate3d(var(--parallax-shift-x, 0px), var(--parallax-shift-y, 0px), 0);
        transition: transform 320ms linear;
    }

    .motion-full .particle-layer {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 2;
        opacity: 0.35;
    }

    .motion-full .particle {
        position: absolute;
        width: var(--size, 4px);
        height: var(--size, 4px);
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.95), rgba(173, 210, 255, 0.2));
        box-shadow: 0 0 9px rgba(165, 205, 255, 0.5);
    }

    body.low-spec .particle-layer,
    body.motion-reduced .particle-layer {
        display: none !important;
    }

    @media (prefers-reduced-motion: reduce) {
        body:not(.force-motion) *,
        body:not(.force-motion) *::before,
        body:not(.force-motion) *::after {
            animation-duration: 0.001ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.001ms !important;
            scroll-behavior: auto !important;
        }
    }

/* =========================================
   RESPONSIVE DESIGN PATCH (Mobile, Tablet, TV)
   ========================================= */

/* --- GLOBAL RESPONSIVE FIXES --- */
:root {
    --bottom-nav-height: 70px;
    --safe-area-bottom: env(safe-area-inset-bottom);
}

/* Dynamic Font Sizing for better scaling */
html {
    font-size: 16px;
}

body.compact-layout .content-area {
    padding: 10px;
}

body.compact-layout .glass-card {
    padding: 14px;
}

/* =========================================
   RESPONSIVE DESIGN PATCH (Mobile, Tablet, TV)
   ========================================= */

/* --- GLOBAL RESPONSIVE FIXES --- */
:root {
    --bottom-nav-height: 70px;
    --safe-area-bottom: env(safe-area-inset-bottom);
}

/* Dynamic Font Sizing for better scaling */
html {
    font-size: 16px;
}

/* 1. MOBILE DESIGN (Phones, < 768px) */
@media screen and (max-width: 768px) {

    /* Layout Reset: Stack vertically */
    .app-container {
        display: flex; /* Override Grid */
        flex-direction: column;
        height: 100vh; /* Fallback */
        height: calc(var(--vh, 1vh) * 100); /* Real mobile height */
    }

    /* Main Content Area */
    .main-content {
        flex: 1;
        width: 100%;
        overflow: hidden;
        border-radius: 0;
    }

    .content-area {
        padding: 15px;
        /* Ensure content doesn't get hidden behind bottom nav */
        padding-bottom: calc(var(--bottom-nav-height) + 20px + var(--safe-area-bottom)); 
    }

    /* Header adjustments */
    .header {
        margin: 10px 10px 0 10px;
        padding: 10px 15px;
        flex-direction: column;
        gap: 10px;
        height: auto;
    }

    .header-version-table {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        grid-template-areas:
            "v1 v2"
            "v3 v4";
    }

    .header-version-table .header-version-cell:nth-child(1) { grid-area: v1; }
    .header-version-table .header-version-cell:nth-child(2) { grid-area: v2; }
    .header-version-table .header-version-cell:nth-child(3) { grid-area: v3; }
    .header-version-table .header-version-cell:nth-child(4) { grid-area: v4; }

    .header-version-cell {
        min-height: 38px;
    }

    .header-version-cell {
        justify-content: center;
        padding: 6px 8px;
    }

    .header-version-label {
        font-size: 0.78rem;
        text-align: center;
    }

    .search-bar {
        width: 100%; /* Full width search */
    }

    /* Transform Sidebar into Bottom Navigation Bar */
    .sidebar {
        order: 2; /* Move to bottom */
        width: 100%;
        height: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
        flex-direction: row;
        padding: 5px 10px var(--safe-area-bottom) 10px;
        justify-content: space-between;
        align-items: center;
        background: rgba(20, 20, 20, 0.95) !important; /* Solid background for visibility */
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid var(--glass-border);
        border-right: none;
        border-radius: 20px 20px 0 0;
        z-index: 1000;
        position: relative;
    }

    /* Hide Logo & Footer in Bottom Nav Mode */
    .sidebar .logo, 
    .sidebar-footer {
        display: none !important;
    }

    /* Nav List Horizontal */
    .nav-list {
        display: flex;
        flex-direction: row;
        width: 100%;
        justify-content: space-around;
        margin: 0;
    }

    .nav-list li {
        margin: 0;
        flex: 1;
        display: flex;
        justify-content: center;
    }

    .nav-link {
        padding: 8px;
        font-size: 0.75rem; /* Smaller text */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        border-radius: 8px;
        white-space: nowrap;
    }

    /* Settings Toggle (Move to Header or float) */
    #settingsMainBtn {
        /* On mobile, we might want this accessible elsewhere, 
           but for now let's put a floater or hide it inside an overlay */
        position: fixed;
        bottom: calc(var(--bottom-nav-height) + 20px);
        right: 20px;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        padding: 0;
        font-size: 24px;
        z-index: 999;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    /* Game Dashboard: Stack Columns */
    .game-dashboard {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    /* Math Calculator: Mobile Optimization */
    .math-input {
        flex-direction: column;
        align-items: flex-start;
        background: rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: 10px;
    }

    .math-input input {
        width: 100%; /* Full width inputs */
        margin: 5px 0;
    }

    /* Settings Overlay: Scrollable */
    .settings-wrapper {
        height: 100%;
        overflow-y: auto; /* Allow scrolling on small screens */
        padding-top: 60px; /* Space for close button */
    }

    .settings-grid {
        display: grid;
        grid-template-columns: 1fr; /* Single column settings */
        gap: 10px;
    }

    /* Top Center Alert Mobile Fix */
    .top-center-alert {
        min-width: 90%;
        width: 90%;
        white-space: normal; /* Allow text wrap */
        font-size: 12px;
        top: -200px;
        padding: 10px;
        flex-direction: row;
    }
}

/* 2. TABLET / SMALL LAPTOP (769px - 1024px) */
@media screen and (min-width: 769px) and (max-width: 1024px) {
    .sidebar {
        width: 200px; /* Slimmer sidebar */
    }

    .logo {
        font-size: 18px;
    }

    .game-dashboard {
        grid-template-columns: 1fr 1fr; /* 2 columns */
    }

    .achievements-panel {
        grid-column: span 2;
    }
}

/* 3. TV / 4K DISPLAYS (> 1920px) */
@media screen and (min-width: 1921px) {
    html {
        font-size: 20px; /* Base scale up */
    }

    .app-container {
        max-width: 2560px; /* Limit width on ultra-wide */
        margin: 0 auto;
        box-shadow: 0 0 50px rgba(0,0,0,0.5);
    }

    .sidebar {
        width: 350px;
    }

    .glass-card {
        padding: 40px;
    }

    /* Focus States for Remote Navigation */
    button:focus, input:focus, .nav-link:focus {
        outline: 4px solid var(--accent-color);
        outline-offset: 4px;
        transform: scale(1.05);
        background: rgba(255,255,255,0.1);
    }
}

/* 4. LANDSCAPE MOBILE (Height constrained) */
@media screen and (max-height: 500px) and (orientation: landscape) {
    .app-container {
        flex-direction: row; /* Keep sidebar on left */
    }

    .sidebar {
        width: 80px; /* Icon only mode basically */
        height: 100vh;
        overflow-y: auto;
    }

    .nav-link {
        font-size: 0; /* Hide text */
        padding: 15px;
    }

    .nav-link::before {
        content: attr(data-tab); /* Or icon logic */
        font-size: 12px;
        display: block;
    }

    .logo { display: none; }

    .header { display: none; } /* Hide header to save vertical space */
}

/* 5. ACCESSIBILITY & TOUCH TARGETS */
@media (pointer: coarse) {
    /* Larger hit areas for fingers */
    .nav-link, .btn-primary, .math-button, .menu-item-large {
        min-height: 48px; 
    }

    input[type="number"], input[type="text"], input[type="password"] {
        font-size: 16px; /* Prevents iOS zoom on focus */
    }
}

</style>
  <style>
    .content-area, .tab-content {
    background: transparent !important;
}

.content-area {
    flex: 1;
    height: 100%;
    overflow-y: auto; /* Only the content area should scroll, not the whole page */
    padding-bottom: 50px; /* Add a little breathing room at the very bottom */
}

html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden; /* Prevents the 'ghost' scrollbar at the bottom */
    font-family: var(--main-font) !important;
}

/* =========================================
   1. VARIABLES & RESET
   ========================================= */
:root {
    /* LIGHT MODE PALETTE */
    --bg-color: #e0e5ec;
    --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --text-color: #333;
    --glass-bg: rgba(255, 255, 255, 0.65);
    --glass-border: rgba(255, 255, 255, 0.5);
    --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    --accent-color: #4f46e5;
    --danger-color: #ff4b4b;
    --nav-active: rgba(0, 0, 0, 0.05);
    --main-font: 'Inter', system-ui, -apple-system, sans-serif;
}

body.dark-theme {
    /* DARK MODE PALETTE (Default) */
    --bg-color: #111;
    --bg-gradient: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
    --text-color: #eee;
    --glass-bg: rgba(20, 20, 20, 0.7);
    --glass-border: rgba(255, 255, 255, 0.08);
    --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
    --accent-color: #6366f1;
    --danger-color: #ff6b6b;
    --main-font: 'Inter', system-ui, -apple-system, sans-serif;
    --nav-active: rgba(255, 255, 255, 0.1);
}

* { box-sizing: border-box; outline: none; }

body {
    margin: 0;
    font-family: var(--main-font);
    background: var(--bg-gradient);
    background-attachment: fixed; /* Keeps gradient specific when scrolling */
    color: var(--text-color);
    height: 100vh;
    overflow: hidden; /* App-like feel */
    transition: color 0.3s ease;
}

h1, h2, h3, .logo, .big-stat {
    font-family: var(--main-font);
    font-weight: 700; 
    letter-spacing: -0.02em; /* Inter looks better slightly tightened */
}

.nav-link, .btn-primary {
    font-family: var(--main-font);
    font-weight: 500;
}

code, .modern-details {
    /* Keep monospace only for technical data */
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 12px;
}

/* =========================================
   2. LAYOUT & GLASS COMPONENTS
   ========================================= */
.app-container {
    height: 100vh; /* Force it to take exactly the full screen height */
    width: 100vw;
    display: flex;
    overflow: hidden; /* Prevents internal elements from pushing the bottom out */

    /* Reveal Animation Logic */
    opacity: 0;
    visibility: hidden;
    transition: opacity 1s ease;
}

.app-container.app-ready {
    opacity: 1;
    visibility: visible;
    transform: scale(1) translateY(0);
}

.glass-panel, .glass-card {
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-shadow);
}

.glass-card {
    /* MUST have semi-transparent background for blur to work */
    background: var(--glass-bg) !important; 

    /* Apply blur to all cards */
    backdrop-filter: blur(15px) saturate(160%) !important;
    -webkit-backdrop-filter: blur(15px) saturate(160%) !important;

    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: var(--glass-shadow);
}

/* SIDEBAR */
.sidebar {
    width: 260px;
    display: flex;
    flex-direction: column;
    padding: 20px;
    z-index: 10;
}

.sidebar-footer {
    margin-top: auto;
    padding-top: 20px;
}

.btn-settings-toggle {
    width: 100%;
    padding: 12px;
    font-family: var(--main-font);
    background: var(--accent-color);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
}

.logo {
    font-size: 22px;
    font-weight: 800;
    margin-bottom: 30px;
    color: var(--accent-color);
    letter-spacing: 1px;
}

.nav-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
.nav-list li { margin-bottom: 10px; }

.nav-link {
    width: 100%;
    text-align: left;
    background: transparent;
    border: none;
    color: var(--text-color);
    padding: 12px 15px;
    font-size: 15px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.nav-link:hover { background: var(--nav-active); transform: translateX(5px); }
.nav-link.active { background: var(--accent-color); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }

/* MAIN CONTENT */
.main-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
}

/* HEADER */
.header {
    padding: 15px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 20px 20px 0 20px;
    border-radius: 16px;
}

.header-version-table {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 8px;
    flex: 1 1 auto;
    min-width: 0;
    align-items: stretch;
    justify-items: stretch;
}

.header-version-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    min-width: 0;
    padding: 6px 10px;
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.08);
    line-height: 1.2;
    width: 100%;
    box-sizing: border-box;
}

body.dark-theme .header-version-cell {
    background: rgba(255, 255, 255, 0.06);
}

.header-version-label {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    text-align: center;
}

.header-version-cell .badge {
    margin-left: 0;
}

.badge {
    background: var(--accent-color);
    color: white;
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 11px;
    margin-left: 8px;
}
.badge.red { background: var(--danger-color); }

.search-bar {
    background: rgba(0,0,0,0.1);
    border: 1px solid var(--glass-border);
    padding: 8px 15px;
    border-radius: 20px;
    color: var(--text-color);
    width: 250px;
}
body.dark-theme .search-bar { background: rgba(255,255,255,0.1); }

/* TAB CONTENTS */
.tab-content {
    padding: 20px;
    overflow-y: auto;
    height: 100%;
    will-change: transform, opacity; 
}

.tab-content:not(.hidden) {
    display: block; /* or flex, depending on your layout */
    animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

.hidden { display: none !important; }

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(30px); /* Start 30px to the right */
    }
    to {
        opacity: 1;
        transform: translateX(0);    /* End at natural position */
    }
}

/* =========================================
   3. UI ELEMENTS (Buttons, Inputs)
   ========================================= */
.btn-primary, .btn-small {
    background: var(--accent-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: filter 0.2s, transform 0.1s;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
.btn-primary:active { transform: scale(0.98); }

.btn-small { padding: 6px 12px; font-size: 12px; }
.btn-small.danger { background: var(--danger-color); }

.text-danger { color: var(--danger-color); }
.text-muted { opacity: 0.6; }

/* =========================================
   4. GAME STYLES
   ========================================= */
.game-dashboard { display: grid; gap: 20px;  background: transparent !important; border: transparent !important;}
.big-stat { font-size: 42px; font-weight: 800; margin: 10px 0; }
.big-btn { width: 100%; padding: 15px; font-size: 18px; margin-top: 15px; }

.modern-table { width: 100%; border-collapse: collapse; }
.modern-table th { text-align: left; padding: 10px; border-bottom: 2px solid var(--glass-border); opacity: 0.7; }
.modern-table td { padding: 12px 10px; border-bottom: 1px solid var(--glass-border); }

/* =========================================
   5. OVERLAY & SNACKBAR
   ========================================= */
.glass-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(15px);
    z-index: 9999;
    display: none; /* Hidden by default */
    justify-content: center; align-items: center;
}
.glass-overlay.active { display: flex; animation: fadeIn 0.3s; }

.login-box { width: 350px; text-align: center; background: var(--bg-color); }
.login-box input { 
    width: 100%; padding: 10px; margin: 15px 0; 
    background: rgba(128,128,128,0.1); border: 1px solid var(--glass-border); color: var(--text-color); border-radius: 6px; 
}

#snackbar-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
    pointer-events: none; /* Allows you to click 'through' the blank space */
}

.snackbar {
    background: #333; color: white; padding: 12px 25px; border-radius: 50px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.3); margin-top: 10px;
    animation: slideUp 0.3s ease-out;
}

/* =========================================
   6. ANIMATIONS
   ========================================= */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* BOTTOM CONTROLS */
.bottom-controls { margin-top: auto; display: flex; gap: 5px; flex-wrap: wrap; }
#commandInput { flex-grow: 1; background: rgba(0,0,0,0.2); border: none; padding: 8px; border-radius: 6px; color: white; }

/* Sidebar Button */
/* --- FULL PAGE SETTINGS --- */
.full-page-overlay {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    z-index: 150000;
    display: none;
    opacity: 0;
    pointer-events: none;
    justify-content: center;
    align-items: center;
    transition: opacity 0.3s cubic-bezier(0.22, 1, 0.36, 1);

    /* THE FIX: Very low alpha (0.3) + Heavy Blur */
    background: rgba(0, 0, 0, 0.9) !important; 
    backdrop-filter: blur(25px) saturate(160%) !important;
    -webkit-backdrop-filter: blur(25px) saturate(160%) !important;
}
.full-page-overlay.active {
    display: flex;
    opacity: 1;
    pointer-events: auto;
}

.full-page-overlay.closing {
    display: flex;
    opacity: 0;
    pointer-events: none;
}

.settings-wrapper {
    width: 100%;
    max-width: 800px;
    padding: 20px;
    position: relative;
}

.settings-content-box {
    animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative;
}

.hidden-page { display: none; }

/* Wide Navigation Items */
.menu-item-large {
    width: 100%;
    display: flex;
    align-items: center;
    padding: 20px;
    margin-bottom: 15px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 15px;
    color: white;
    cursor: pointer;
    transition: 0.3s;
}

.menu-item-large:hover {
    background: rgba(255,255,255,0.1);
    transform: scale(1.02);
}

.menu-item-large .icon { font-size: 30px; margin-right: 20px; }
.text-group { text-align: left; }
.text-group strong { display: block; font-size: 18px; }
.text-group span { font-size: 14px; opacity: 0.6; }

.top-center-alert {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    transform: translateY(calc(-100% - 12px));
    opacity: 0;
    pointer-events: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    min-width: 0;
    max-width: 100%;
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    background: #FFD700; /* Yellow */
    color: #000;
    padding: 12px 18px;
    border-radius: 0 0 16px 16px;
    font-weight: 700;
    z-index: 9999999; /* Stays above Settings */
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    transition: transform 0.48s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.28s ease;
    box-sizing: border-box;
    will-change: transform, opacity;
}

.top-center-alert.show {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
}

.close-alert-btn {
    background: rgba(0,0,0,0.1);
    border: none;
    font-size: 20px;
    font-weight: bold;
    margin-left: 12px;
    cursor: pointer;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 0 0 36px;
    min-width: 36px;
    min-height: 36px;
    padding: 0;
    touch-action: manipulation;
}

.close-alert-btn:hover { background: rgba(0,0,0,0.2); }

.top-center-alert > span {
    display: block;
    flex: 1 1 auto;
    min-width: 0;
    line-height: 1.35;
}

    /* First-Time Performance Prompt */
    .first-time-perf-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: max(24px, env(safe-area-inset-top, 0px) + 16px);
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        z-index: 2147483647;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.35s ease, backdrop-filter 0.35s ease, -webkit-backdrop-filter 0.35s ease, background 0.35s ease;
    }

    .first-time-perf-overlay.show {
        opacity: 1;
        pointer-events: auto;
    }

    .first-time-perf-overlay.fade-out {
        opacity: 0;
        background: rgba(0, 0, 0, 0);
        backdrop-filter: blur(0px);
        -webkit-backdrop-filter: blur(0px);
        pointer-events: none;
    }

    .first-time-perf-window {
        width: min(92vw, 520px);
        border-radius: 16px;
        border: 1px solid var(--glass-border);
        background: rgba(20, 25, 36, 0.9);
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.5);
        padding: 22px;
        transform: translateY(-10px);
        opacity: 0;
        transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.35s ease;
    }

    .first-time-perf-overlay.show .first-time-perf-window {
        transform: translateY(0);
        opacity: 1;
    }

    .first-time-perf-overlay.fade-out .first-time-perf-window {
        transform: translateY(-12px);
        opacity: 0;
    }

    .first-time-perf-window h3 {
        margin: 0 0 10px;
        font-size: 1.15rem;
    }

    .first-time-perf-window p {
        margin: 0 0 16px;
        color: var(--text-muted);
    }

    .first-time-perf-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .first-time-perf-btn {
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 600;
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: transform 0.2s ease, opacity 0.2s ease, background 0.2s ease, border-color 0.2s ease;
    }

    .first-time-perf-btn:hover {
        transform: translateY(-1px);
    }

    .first-time-perf-btn.yes {
        border: 1px solid transparent;
        background: var(--accent-color);
        color: #fff;
    }

    .first-time-perf-btn.no {
        border: 1px solid var(--glass-border);
        background: transparent;
        color: #fff;
    }


.glass-card, .tab-content > * {
    backdrop-filter: blur(15px) saturate(160%);
    -webkit-backdrop-filter: blur(15px) saturate(160%);
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
}

/* Back & Close Buttons */
.close-overlay {
    position: absolute; top: 40px; right: 40px;
    font-size: 40px; color: white; background: none; border: none; cursor: pointer;
}

.back-btn {
    position: static; 
    top: 40px; 
    right: 720px; /* Positioned to the left of the close button */
    background: none; 
    border: none; 
    color: white;
    cursor: pointer; 
    font-weight: bold; 
    z-index: 10;
    padding: 8px 16px;
    border-radius: 6px;
    transition: background 0.2s;
    font-size: 18px;
}

.back-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

/* Animations */
@keyframes fullFadeIn {
    from { opacity: 0; backdrop-filter: blur(0px); }
    to { opacity: 1; backdrop-filter: blur(20px); }
}

@keyframes slideUpFade {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* --- PERFORMANCE MODE OVERRIDE --- */
/* --- PERFORMANCE MODE ENGINE --- */

/* 1. Force remove blurs from every possible glass element */


/* Ensure settings button is visible in sidebar footer */
.sidebar-footer {
    margin-top: auto;
    padding: 15px;
}

.btn-settings-toggle {
    width: 100%;
    padding: 12px;
    background: rgba(255,255,255,0.1);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    color: var(--text-color);
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}
.btn-settings-toggle:hover { background: var(--accent-color); color: white; }

body.low-spec .glass-card, 
body.low-spec .sidebar, 
body.low-spec .glass-panel,
body.low-spec .full-page-overlay,
body.low-spec .tab-content,
body.low-spec .login-box,
body.low-spec #settingsOverlay {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    /* Use a solid, non-transparent color to save GPU power */
    background: #1a1a1a !important; 
    box-shadow: none !important;
    border: 1px solid #333 !important;
}

/* 2. Fix text visibility in performance mode */
body.low-spec .glass-card *, 
body.low-spec .sidebar * {
    text-shadow: none !important;
}

/* 3. Handle Light Mode Performance */
body.low-spec:not(.dark-theme) .glass-card,
body.low-spec:not(.dark-theme) .sidebar {
    background: #d1d9e6 !important;
    border: 1px solid #b8c6db !important;
}

/* --- TERMINAL DESIGN --- */
.terminal-header {
    background: #333;
    padding: 10px 15px;
    border-radius: 12px 12px 0 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.dot { width: 12px; height: 12px; border-radius: 50%; }
.red { background: #ff5f56; }
.yellow { background: #ffbd2e; }
.green { background: #27c93f; }
.terminal-title { color: #aaa; font-size: 12px; font-family: monospace; margin-left: 10px; }

.terminal-body {
    background: #1a1a1a;
    padding: 20px;
    border-radius: 0 0 12px 12px;
    border: 1px solid #333;
}

.command-line {
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: var(--main-font);
    color: #00ff00; /* Classic Terminal Green */
    margin-bottom: 20px;
}

.prompt { white-space: nowrap; }

#commandInput {
    background: transparent;
    border: none;
    color: #fff;
    outline: none;
    width: 100%;
    font-family: inherit;
}

.terminal-hint {
    font-size: 11px;
    opacity: 0.5;
    margin-top: 15px;
    font-style: italic;
}

/* --- PREFERENCES DESIGN --- */
.pref-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 20px;
}

.pref-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.03);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: 0.3s;
}

.pref-card:hover { background: rgba(255, 255, 255, 0.07); }

.pref-info { display: flex; align-items: center; gap: 15px; }
.pref-icon { font-size: 24px; }

.pref-text { text-align: left; }
.pref-text strong { display: block; font-size: 16px; color: #fff; }
.pref-text span { font-size: 13px; color: #888; }

.pref-card.disabled { opacity: 0.5; cursor: not-allowed; }

.switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; inset: 0;
    background-color: #444; transition: .4s; border-radius: 34px;
}
.slider:before {
    position: absolute; content: ""; height: 18px; width: 18px;
    left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(20px); }

/* --- MODERN TERMINAL EXECUTE BUTTON --- */
.btn-execute {
    width: 100%;
    padding: 14px;
    background: transparent;
    color: #00ff00; /* Terminal Green */
    border: 2px solid #00ff00;
    border-radius: 8px;
    font-family: var(--main-font);
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 5px rgba(0, 255, 0, 0.2);
}

.btn-execute:hover {
    background: #00ff00;
    color: #1a1a1a;
    box-shadow: 0 0 20px rgba(0, 255, 0, 0.6);
    transform: translateY(-2px);
}

.btn-execute:active {
    transform: translateY(0);
    box-shadow: 0 0 10px rgba(0, 255, 0, 0.4);
}

/* Subtle scanline effect inside the button on hover */
.btn-execute::after {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        rgba(255, 255, 255, 0.1) 0%,
        rgba(255, 255, 255, 0) 50%
    );
    transform: rotate(30deg);
    transition: 0.5s;
    pointer-events: none;
}

.btn-execute:hover::after {
    left: 100%;
    top: 100%;
}

/* Redesign for the back button in settings */
.back-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #aaa;
    padding: 8px 16px;
    border-radius: 6px;
    font-family: var(--main-font) Impo !important;
    font-size: 13px;
    cursor: pointer;
    transition: 0.2s;
}

.back-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
}

/* --- TERMINAL WINDOW --- */
#pageCommand {
    background: #0d0d0d;
    border-radius: 12px;
    border: 1px solid #333;
    overflow: hidden;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

.terminal-header {
    background: #222;
    padding: 10px 15px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #333;
}

.terminal-body {
    padding: 25px;
    font-family: 'Courier New', monospace;
    position: relative;
}

/* Scanline Effect across the terminal */
.terminal-body::before {
    content: " ";
    position: absolute;
    inset: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
    background-size: 100% 3px, 3px 100%;
    pointer-events: none;
    z-index: 2;
}

.command-line {
    display: flex;
    align-items: center;
    color: #00ff41; /* Matrix Green */
    font-size: 1.1rem;
    text-shadow: 0 0 5px rgba(0, 255, 65, 0.7);
}

#commandInput {
    background: transparent;
    border: none;
    outline: none;
    color: #fff;
    width: 100%;
    padding-left: 10px;
    font-size: 1rem;
}

/* Command Hint Style */
.terminal-hint {
    color: #666;
    font-size: 12px;
    margin-top: 20px;
    border-top: 1px dashed #333;
    padding-top: 10px;
}

/* --- PRESET INTRO SYSTEM --- */
.intro-overlay {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #0f0c29 0%, #302b63 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999999999; /* Higher than anything in existence */
    transition: opacity 1s ease-in-out, visibility 1s;
}

.intro-overlay.active {
    opacity: 1;
    visibility: visible;
}

.intro-content {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

#intro-logo {
    font-size: 5rem;
    font-weight: 800;
    color: white;
    letter-spacing: 10px;
    transform: translateY(100px); /* Start lower for better slide-up */
    opacity: 0;
    transition: transform 1.5s cubic-bezier(0.16, 1, 0.3, 1), opacity 1.5s ease;
}

#intro-logo.animate {
    transform: translateY(0);
    opacity: 1;
}

.intro-overlay.fade-out {
    opacity: 0;
    visibility: hidden;
}

/* Loading Spinner */
.loader {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    opacity: 0;
    transition: opacity 0.5s ease;
}

.loader.show { opacity: 1; }

@keyframes spin {
    to { transform: rotate(360deg); }
}

.hidden { display: none; }

/* Content Fade Out Class */
.fade-out {
    opacity: 0 !important;
    pointer-events: none;
}

/* Logic for blocking text selection */
body.locked-access {
    user-select: none;
    -webkit-user-select: none;
}

body.locked-access input, 
body.locked-access textarea {
    user-select: text !important;
    -webkit-user-select: text !important;
}

/* Block selection by default */
body.lock-selection {
    user-select: none !important;
    -webkit-user-select: none !important;
}

/* Allow typing in terminal even when locked */
body.lock-selection input, 
body.lock-selection textarea {
    user-select: text !important;
    -webkit-user-select: text !important;
}

/* Ensure the hidden tab is actually hidden until command is run */
#resources.hidden {
    display: none !important;
}

/* --- RESPONSIVE ENGINE --- */

@media screen and (max-width: 900px) {
    /* 1. Flip layout to vertical */
    .app-container {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 70px; /* Sidebar becomes bottom bar */
        height: 100vh;
    }

    /* 2. Transform Sidebar into Bottom Nav */
    .sidebar {
        grid-row: 2;
        width: 100%;
        height: 70px;
        flex-direction: row;
        padding: 0 10px;
        justify-content: space-around;
        border-right: none;
        border-top: 1px solid var(--glass-border);
        border-radius: 0;
    }

    .sidebar .logo {
        display: none; /* Hide logo on mobile nav to save space */
    }

    .nav-links {
        flex-direction: row;
        width: 100%;
        justify-content: space-evenly;
        gap: 0;
    }

    .nav-link {
        flex-direction: column;
        gap: 4px;
        font-size: 10px;
        padding: 8px;
        text-align: center;
    }

    .nav-link i { font-size: 20px; }

    /* 3. Adjust Content Area */
    .content-area {
        padding: 20px;
        padding-bottom: 100px; /* Space for the bottom nav */
    }

    /* 4. Rescale Intro Logo */
    #intro-logo {
        font-size: 2.5rem;
        letter-spacing: 5px;
    }

    /* 5. Modernize Cards for Mobile */
    .glass-card {
        padding: 20px;
        margin-bottom: 15px;
    }

    /* Adjust settings buttons for mobile */
    .back-btn {
        top: 20px;
        right: 60px;
        font-size: 16px;
    }

    .close-overlay {
        top: 20px;
        right: 20px;
        font-size: 30px;
    }
}

/* For very small phones */
@media screen and (max-width: 480px) {
    .big-stat { font-size: 2rem; }
    .btn-execute { width: 100%; }
    .terminal-header { font-size: 12px; }

    .back-btn {
        top: 15px;
        right: 55px;
        padding: 6px 12px;
    }

    .close-overlay {
        top: 15px;
        right: 15px;
        font-size: 24px;
    }
}

/* Math Calculator Styles */
.math-calculator {
    display: flex;
    border: transparent !important;
    background: transparent !important;
    flex-direction: column;
    gap: 15px;
}

.math-button {
    width: 100%;
    padding: 15px;
    font-size: 16px;
    background: var(--accent-color);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
    text-align: center;
}

.math-button:hover {
    filter: brightness(1.1);
    transform: translateY(-1px);
}

.math-button:active {
    transform: scale(0.98);
}

.math-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.math-input {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.math-input input {
    width: 60px;
    padding: 8px;
    border: none;
    border-radius: 6px;
    background: transparent;
    color: var(--text-color);
    outline: none;
    border-bottom: 2px solid #666;
    transition: all 0.3s ease;
}

.math-input input:focus {
    border-bottom: 2px solid var(--accent-color);
    box-shadow: 0 5px 15px -10px rgba(102, 126, 234, 0.5);
}

.math-equation {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-wrap: wrap;
}

.math-result {
    margin-top: 15px;
    padding: 15px;
    background: rgba(128,128,128,0.1);
    border-radius: 8px;
    border: 1px solid var(--glass-border);
}

.math-steps {
    margin-top: 10px;
    padding: 15px;
    background: rgba(0,0,0,0.1);
    border-radius: 8px;
    font-family: 'Inter', sans-serif;
    white-space: pre-wrap;
    line-height: 1.6;
    border: 1px solid var(--glass-border);
}

/* Neon text input styling */
.math-input input[type="number"] {
    border: none;
    outline: none;
    background: transparent;
    border-radius: 0;
    border-bottom: 2px solid #666;
    transition: all 0.3s ease;
}

.math-input input[type="number"]:focus {
    border-bottom: 2px solid var(--accent-color);
    box-shadow: 0 5px 15px -10px rgba(102, 126, 234, 0.5);
}

/* Ensure Calculate and Clear buttons have same height */
.math-buttons {
    display: flex;
    gap: 10px;
}

.math-buttons .btn-primary,
.math-buttons .btn-small {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 15px;
}

/* MathJax styling for LaTeX */
.MathJax {
    font-size: 1.1em !important;
}

.step-number {
    display: inline-block;
    background: var(--accent-color);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    text-align: center;
    line-height: 24px;
    font-size: 12px;
    margin-right: 8px;
    font-weight: bold;
}

.latex-step {
    margin: 8px 0;
    padding: 8px;
    background: rgba(102, 126, 234, 0.1);
    border-left: 3px solid var(--accent-color);
    border-radius: 0 4px 4px 0;
}

.explanation {
    font-style: italic;
    color: #aaa;
    margin: 5px 0;
}

/* New styles for calculator content and back button positioning */
.calculator-content {
    position: relative;
    padding-top: 50px; /* Space for back button */
}

.calculator-back-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    background: none;
    border: none;
    color: var(--accent-color);
    cursor: pointer;
    font-weight: bold;
    padding: 8px 16px;
    border-radius: 6px;
    transition: background 0.2s;
    z-index: 10;
}

.calculator-back-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.calculator-content-inner {
    background: transparent;
    padding: 20px;
    border-radius: 12px;
}

/* Keep the 3 equation pages consistent in spacing */
#linearOneVarPage .calculator-content-inner,
#quadraticOneVarPage .calculator-content-inner,
#linearTwoVarPage .calculator-content-inner,
#linearOneVarPage .math-input,
#quadraticOneVarPage .math-input,
#linearTwoVarPage .math-input,
#linearOneVarPage .math-result,
#quadraticOneVarPage .math-result,
#linearTwoVarPage .math-result,
#linearOneVarPage .math-steps,
#quadraticOneVarPage .math-steps,
#linearTwoVarPage .math-steps {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

.calculator-form {
    background: transparent;
    padding: 0;
}

/* Remove background from calculator form */
.math-calculator .math-form {
    background: transparent;
    padding: 0;
}

/* Ensure consistent button heights */
.math-buttons .btn-primary, 
.math-buttons .btn-small {
    height: 40px;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 16px;
    box-sizing: border-box;
}

/* Input field neon styling */
.math-input input {
    background: transparent;
    border: none;
    border-bottom: 2px solid #666;
    padding: 8px 0;
    font-size: 16px;
    color: var(--text-color);
    transition: all 0.3s ease;
}

.math-input input:focus {
    border-bottom: 2px solid var(--accent-color);
    box-shadow: 0 5px 15px -10px rgba(102, 126, 234, 0.5);
    outline: none;
}

/* Remove any potential background from calculator container */
#math {
    background: transparent;
}

/* Terminal Overlay Styles */
.terminal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000;
    z-index: 999999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 1s ease-in-out;
}

.terminal-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.terminal-content {
    color: white;
    text-align: center;
    font-family: 'Courier New', 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
    font-size: 18px;
    position: relative;
}

.terminal-loader {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin: 20px auto;
}

.terminal-processing {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 24px;
    margin: 20px 0;
}

.countdown-display {
    display: inline-block;
    min-width: 30px;
    text-align: center;
}

.terminal-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 30px;
}

.terminal-option {
    background: #444;
    color: white;
    border: 1px solid #666;
    padding: 12px 24px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Courier New', 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
    font-size: 16px;
    transition: background 0.3s;
}

.terminal-option:hover {
    background: #555;
}

.terminal-title {
    font-size: 28px;
    margin-bottom: 30px;
    font-weight: bold;
}

.terminal-quit {
    margin-top: 20px;
    font-size: 14px;
    color: #aaa;
}

.terminal-quit-loader {
    width: 30px;
    height: 30px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin: 15px auto;
}

/* Success message for terminal clear */
.terminal-success {
    color: #00ff00;
    font-size: 20px;
    margin: 20px 0;
}

.terminal-back-btn {
    background: #444;
    color: white;
    border: 1px solid #666;
    padding: 12px 24px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Courier New', 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
    font-size: 16px;
    transition: background 0.3s;
    margin-top: 20px;
}

.terminal-back-btn:hover {
    background: #555;
}

.terminal-command-box {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: center;
}

.terminal-command-row {
    display: flex;
    gap: 8px;
    width: min(520px, calc(100vw - 32px));
}

.terminal-command-input {
    flex: 1;
    border: 1px solid #3f3f3f;
    background: #0f0f0f;
    color: #f5f5f5;
    border-radius: 6px;
    padding: 10px;
    font-family: inherit;
}

.terminal-command-btn {
    border: 1px solid #6d6d6d;
    background: #2d2d2d;
    color: #f5f5f5;
    border-radius: 6px;
    padding: 10px 14px;
    cursor: pointer;
    font-family: inherit;
}

.terminal-command-feedback {
    min-height: 20px;
    color: #86efac;
    font-size: 12px;
}

.terminal-option.root-editor {
    background: #203a35;
    border-color: #3f8b78;
}

.root-editor-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000005;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
}

.root-editor-modal.active {
    display: flex;
}

.root-editor-card {
    width: min(820px, 100%);
    max-height: 88vh;
    overflow: auto;
    background: #0f172a;
    border: 1px solid rgba(148, 163, 184, 0.35);
    border-radius: 12px;
    color: #e2e8f0;
    padding: 18px;
}

.root-editor-grid {
    display: grid;
    gap: 10px;
}

.root-editor-grid input,
.root-editor-grid textarea,
.root-editor-grid select {
    width: 100%;
    box-sizing: border-box;
    border-radius: 8px;
    border: 1px solid rgba(148, 163, 184, 0.4);
    background: #020617;
    color: #e2e8f0;
    padding: 10px;
    font-family: inherit;
}

.root-editor-actions {
    margin-top: 14px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.root-editor-actions button {
    border-radius: 8px;
    border: 1px solid rgba(148, 163, 184, 0.45);
    background: #1e293b;
    color: #f8fafc;
    padding: 9px 14px;
    cursor: pointer;
}

.root-editor-actions button.danger {
    background: #7f1d1d;
}

.root-editor-log {
    margin-top: 12px;
    background: rgba(15, 23, 42, 0.75);
    border: 1px solid rgba(148, 163, 184, 0.25);
    border-radius: 8px;
    padding: 10px;
    font-size: 12px;
    white-space: pre-wrap;
}

/* Console font for terminal */
.console-font {
    font-family: 'Courier New', 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
}

/* Draggable in-web windows (Test Mode / Error) */
.system-window {
    position: fixed;
    top: 12vh;
    left: 50%;
    transform: translateX(-50%);
    width: min(420px, calc(100vw - 24px));
    max-height: min(78vh, 560px);
    display: flex;
    flex-direction: column;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(14, 18, 28, 0.95);
    color: #f2f5ff;
    box-shadow: 0 24px 60px rgba(0, 0, 0, 0.45);
    z-index: 1000002;
    overflow: hidden;
    resize: none;
}

.system-window.error-window {
    width: min(440px, calc(100vw - 24px));
}

.system-window-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 12px 14px;
    background: rgba(255, 255, 255, 0.08);
    border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    cursor: move;
    user-select: none;
    touch-action: none;
}

.system-window-title {
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.02em;
    cursor: pointer;
}

.system-window-close {
    width: 26px;
    height: 26px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.22);
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-weight: 700;
    cursor: pointer;
}

.system-window-body {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow: auto;
}

.system-window.collapsed .system-window-body {
    display: none;
}

.system-window-action {
    width: 100%;
    border: 1px solid rgba(255, 255, 255, 0.24);
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    padding: 10px 12px;
    border-radius: 10px;
    text-align: left;
    font-size: 14px;
    cursor: pointer;
}

.system-window-action:hover {
    background: rgba(255, 255, 255, 0.16);
}

.system-window-action.danger {
    border-color: rgba(248, 113, 113, 0.55);
    background: rgba(248, 113, 113, 0.12);
}

.system-window-action.warning {
    border-color: rgba(250, 204, 21, 0.55);
    background: rgba(250, 204, 21, 0.14);
    color: #fff6cf;
}

.system-window-message {
    margin: 0;
    line-height: 1.45;
    font-size: 14px;
    color: #f7d3d3;
}

/* Achievement System Styles */
.achievement-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.achievement-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
}

.achievement-card.unlocked {
    background: rgba(74, 222, 128, 0.1);
    border-color: rgba(74, 222, 128, 0.3);
}

.achievement-card.locked {
    opacity: 0.6;
}

.achievement-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.achievement-info {
    flex: 1;
}

.achievement-title {
    font-weight: 600;
    margin-bottom: 5px;
    color: #fff;
}

.achievement-desc {
    font-size: 13px;
    color: #aaa;
}

.achievement-progress {
    width: 100%;
    height: 5px;
    background: rgba(255,255,255,0.1);
    border-radius: 3px;
    margin-top: 8px;
    overflow: hidden;
}

.achievement-progress-bar {
    height: 100%;
    background: var(--accent-color);
    border-radius: 3px;
    width: 0%;
    transition: width 0.5s ease;
}

.achievement-unlocked-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    background: var(--accent-color);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
}

.update-check-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.update-status {
    font-size: 24px;
    margin: 15px 0;
    font-weight: 600;
}

.update-status.new-available {
    color: #ff6b6b;
}

.update-status.current {
    color: #4ade80;
}

.update-info {
    margin-top: 15px;
    font-size: 14px;
    color: #aaa;
}

.update-badge {
    display: inline-block;
    background: var(--accent-color);
    color: white;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    margin: 0 5px;
}

/* Translate section styles */
.translate-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 20px;
}

.translate-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.03);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: 0.3s;
    cursor: pointer;
}

.translate-card:hover { background: rgba(255, 255, 255, 0.07); }

.translate-info { display: flex; align-items: center; gap: 15px; }
.translate-icon { font-size: 24px; }

.translate-text { text-align: left; }
.translate-text strong { display: block; font-size: 16px; color: #fff; }
.translate-text span { font-size: 13px; color: #888; }

.checkmark { 
    font-size: 24px; 
    color: #4ade80; 
    display: none; 
}

.translate-card.selected .checkmark { 
    display: block; 
}

.language-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}

.language-name { flex: 1; }

/* Language change overlay */
.language-change-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: black;
    z-index: 999999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
}

.language-change-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.language-change-text {
    color: white;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
}

.language-change-loader {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

/* Game dashboard with achievements */
.game-dashboard {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.stats-panel, .upgrades-panel {
    min-width: 0; /* Allow flex items to shrink below their content size */
}

.achievements-panel {
    grid-column: 1 / -1; /* Span across both columns */
    background: transparent !important;
    border: transparent !important;
}

.achievements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

/* Update section in settings */
.update-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.update-action {
    margin-top: 15px;
}

.update-check-btn {
    background: var(--accent-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: filter 0.2s;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.update-check-btn:hover { filter: brightness(1.1); }

.update-result {
    margin-top: 15px;
    font-size: 14px;
    color: #aaa;
}

.update-result.success { color: #4ade80; }
.update-result.error { color: #ff6b6b; }

.update-result .version-badge {
    display: inline-block;
    background: var(--accent-color);
    color: white;
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 11px;
    margin-left: 8px;
}

/* Responsive adjustments for game dashboard */
@media screen and (max-width: 768px) {
    .game-dashboard {
        grid-template-columns: 1fr;
    }

    .stats-panel, .upgrades-panel {
        min-width: unset;
    }

    .achievements-panel {
        grid-column: 1;
    }
}

/* =========================================
   ADVANCED INTERACTIONS
   ========================================= */
:root {
    --mouse-x: 50vw;
    --mouse-y: 50vh;
    --cursor-flow-size: 280px;
    --cursor-flow-opacity: 0.12;
}

body::before {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    background: radial-gradient(
        var(--cursor-flow-size) circle at var(--mouse-x) var(--mouse-y),
        rgba(99, 102, 241, var(--cursor-flow-opacity)),
        rgba(99, 102, 241, 0) 68%
    );
}

.app-container {
    position: relative;
    z-index: 1;
}

body.low-spec::before {
    display: none;
}

.tab-content {
    transition: none;
    opacity: 1;
    transform: none;
}

.tab-content:not(.hidden) {
    animation: none;
}

.tab-content.tab-leave,
.tab-content.tab-enter,
.tab-content.tab-enter.tab-enter-active {
    opacity: 1;
    transform: none;
}

/* Animate only tab inner content, keep tab/background layer stable */
.tab-content.tab-leave {
    pointer-events: none;
}

.tab-content.tab-leave > * > * {
    opacity: 0;
    transform: translateY(-8px);
    transition: opacity 0.22s ease, transform 0.22s ease;
}

.tab-content.tab-enter > * > * {
    opacity: 0;
    transform: translateY(10px);
}

.tab-content.tab-enter.tab-enter-active > * > * {
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.26s ease, transform 0.26s ease;
}

.tab-content.tab-enter.tab-enter-active > * > *:nth-child(2) {
    transition-delay: 35ms;
}

.tab-content.tab-enter.tab-enter-active > * > *:nth-child(3) {
    transition-delay: 70ms;
}

.scroll-reveal {
    opacity: 0;
    transform: translateY(24px);
    transition:
        opacity 0.6s ease var(--reveal-delay, 0ms),
        transform 0.6s cubic-bezier(0.16, 1, 0.3, 1) var(--reveal-delay, 0ms);
}

.scroll-reveal.revealed {
    opacity: 1;
    transform: translateY(0);
}

.tilt-card {
    transform: none !important;
    transition: box-shadow 240ms ease;
}

.tilt-card::after {
    display: none !important;
}

body.low-spec .scroll-reveal,
body.low-spec .tab-content {
    opacity: 1 !important;
    transform: none !important;
    transition: none !important;
}

body.low-spec .tab-content.tab-enter > * > * {
    opacity: 1 !important;
    transform: none !important;
    transition: none !important;
}

body.low-spec .tab-content.tab-leave > * > * {
    opacity: 1 !important;
    transform: none !important;
    transition: none !important;
}

.ripple-host {
    position: relative;
    overflow: hidden;
    isolation: isolate;
}

.ripple-wave {
    position: absolute;
    border-radius: 50%;
    transform: scale(0);
    background: rgba(255, 255, 255, 0.35);
    pointer-events: none;
    animation: ripple-wave 650ms ease-out forwards;
}

@keyframes ripple-wave {
    to {
        transform: scale(3.5);
        opacity: 0;
    }
}

#terminalText {
    min-width: min(420px, 80vw);
    text-align: left;
    line-height: 1.45;
}

.terminal-line {
    white-space: pre-wrap;
    opacity: 0;
    transform: translateY(6px);
    animation: terminalLineIn 180ms ease forwards;
}

@keyframes terminalLineIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (prefers-reduced-motion: reduce) {
    .tab-content,
    .scroll-reveal,
    .tilt-card,
    .ripple-wave {
        transition: none !important;
        animation: none !important;
        transform: none !important;
    }

    body::before {
        display: none;
    }

    .tab-content.tab-enter > * > * {
        opacity: 1 !important;
        transform: none !important;
        transition: none !important;
    }

    .tab-content.tab-leave > * > * {
        opacity: 1 !important;
        transform: none !important;
        transition: none !important;
    }
}

/* Responsive stabilization overrides */
@media screen and (max-width: 900px) {
    .app-container {
        display: flex;
        flex-direction: column;
        height: calc(var(--vh, 1vh) * 100);
        width: 100vw;
    }

    .main-content {
        min-height: 0;
        padding-bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
    }

    .header {
        position: sticky;
        top: 0;
        z-index: 30;
        margin: 8px 10px 0 10px;
        padding: 10px 12px;
    }

    .tab-content {
        padding: 14px;
        padding-bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 18px);
        min-height: 0;
    }

    .sidebar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
        padding: 4px 10px var(--safe-area-bottom) 10px;
        border-radius: 18px 18px 0 0;
        z-index: 1100;
    }

    .nav-list {
        display: flex;
        flex-direction: row;
        width: 100%;
        justify-content: space-between;
        margin: 0;
        gap: 4px;
    }

    .nav-list li {
        flex: 1;
        margin: 0;
    }

    .nav-link {
        width: 100%;
        min-height: 44px;
        font-size: 0.74rem;
        padding: 6px 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .sidebar-footer {
        display: block !important;
        position: fixed;
        right: 10px;
        bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 10px);
        margin: 0;
        padding: 0;
        z-index: 1200;
    }

    #settingsMainBtn {
        position: static !important;
        width: auto !important;
        height: 40px !important;
        padding: 0 14px !important;
        border-radius: 999px !important;
        font-size: 12px !important;
        line-height: 1 !important;
    }

    #terminalText {
        min-width: 0;
        width: min(88vw, 420px);
    }

    .terminal-option,
    .terminal-back-btn {
        font-size: 14px;
        padding: 10px 16px;
    }

    .system-window {
        width: calc(100vw - 16px);
        max-height: min(72vh, 500px);
        top: 10vh;
    }
}

@media screen and (max-width: 480px) {
    .logo {
        display: none;
    }

    .header-version-table {
        gap: 6px;
    }

    .header-version-label {
        font-size: 0.72rem;
        line-height: 1.35;
    }

    .search-bar {
        width: 100%;
    }

    .system-window {
        border-radius: 10px;
        width: calc(100vw - 12px);
        top: 8vh;
        max-height: 76vh;
    }

    .glass-card {
        padding: 16px;
    }
}

/* Final mobile refinements */
@media screen and (max-width: 768px) {
    :root {
        --bottom-nav-height: 74px;
    }

    .header {
        align-items: stretch !important;
    }

    .header-version-table {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        grid-template-areas: none !important;
        width: 100% !important;
        max-width: 100%;
        margin: 0 auto;
        align-self: stretch;
        justify-items: stretch;
        justify-content: center;
    }

    .header-version-cell {
        width: 100%;
        grid-area: auto !important;
        justify-content: center;
        flex-wrap: wrap;
        text-align: center;
        row-gap: 4px;
    }

    .header-version-label {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        overflow-wrap: anywhere;
        word-break: break-word;
    }

    .search-bar {
        display: block;
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0;
        box-sizing: border-box;
        align-self: stretch;
        flex: 0 0 auto;
    }

    /* Phone bottom nav redesign: safer insets + readable labels */
    .main-content {
        padding-bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 10px);
    }

    .tab-content {
        padding-bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 24px);
    }

    .sidebar {
        left: 0;
        right: 0;
        width: 100%;
        height: calc(var(--bottom-nav-height) + var(--safe-area-bottom)) !important;
        min-height: calc(var(--bottom-nav-height) + var(--safe-area-bottom)) !important;
        padding: 2px calc(env(safe-area-inset-right, 0px) + 6px) calc(var(--safe-area-bottom) + 2px) calc(env(safe-area-inset-left, 0px) + 6px);
        border-radius: 0;
        border-top: 1px solid var(--glass-border);
        border-left: none;
        border-right: none;
        border-bottom: none;
        background: rgba(16, 16, 16, 0.94) !important;
        box-sizing: border-box;
        overflow: visible;
    }

    .nav-list {
        gap: 5px;
        align-items: center;
        position: relative;
        isolation: isolate;
        --mobile-active-left: 0px;
        --mobile-active-top: 0px;
        --mobile-active-width: 0px;
        --mobile-active-height: 0px;
    }

    .nav-list::before {
        content: "";
        position: absolute;
        left: var(--mobile-active-left);
        top: var(--mobile-active-top);
        width: var(--mobile-active-width);
        height: var(--mobile-active-height);
        border-radius: 10px;
        background: var(--accent-color);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        opacity: 0;
        pointer-events: none;
        z-index: 0;
        transition:
            left 340ms cubic-bezier(0.22, 1, 0.36, 1),
            top 340ms cubic-bezier(0.22, 1, 0.36, 1),
            width 340ms cubic-bezier(0.22, 1, 0.36, 1),
            height 340ms cubic-bezier(0.22, 1, 0.36, 1),
            opacity 140ms linear;
    }

    .nav-list.mobile-indicator-ready::before {
        opacity: 1;
    }

    .nav-list.mobile-indicator-static::before {
        transition: none;
    }

    .nav-list li {
        min-width: 0;
        display: flex;
        position: relative;
        z-index: 1;
    }

    .nav-link {
        min-height: 38px !important;
        padding: 3px 2px;
        font-size: 0.62rem;
        line-height: 1.1;
        white-space: normal !important;
        overflow-wrap: anywhere;
        word-break: break-word;
        text-align: center;
        position: relative;
        z-index: 1;
        transition: color 0.2s ease;
    }

    .sidebar .nav-link:hover {
        transform: none !important;
        background: transparent !important;
    }

    .sidebar .nav-link.active {
        background: transparent !important;
        box-shadow: none !important;
        color: #fff !important;
    }

    .nav-list:not(.mobile-indicator-ready) .nav-link.active {
        background: var(--accent-color) !important;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4) !important;
    }

    .sidebar-footer {
        right: calc(env(safe-area-inset-right, 0px) + 8px);
        bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 14px);
    }

    #snackbar-container {
        left: 0;
        right: 0;
        transform: none;
        width: 100%;
        max-width: none;
        padding: 0 calc(env(safe-area-inset-right, 0px) + 10px) 0 calc(env(safe-area-inset-left, 0px) + 10px);
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
    }

    .snackbar {
        margin-top: 0;
        width: 100%;
        max-width: 100%;
        padding: 11px 14px;
        border-radius: 14px;
        white-space: normal;
        overflow-wrap: break-word;
        word-break: normal;
        line-height: 1.35;
        text-align: center;
        box-sizing: border-box;
    }

    #settingsOverlay {
        position: fixed;
        inset: 0;
        align-items: flex-start;
        justify-content: center;
      overflow: hidden;
    }

  #settingsMainBtn {
      border-radius: 12px !important;
    --shape-open-duration: 620ms;
  }

    #settingsOverlay.shape-transform-enabled {
          opacity: 1;
          background: rgba(0, 0, 0, 0) !important;
          backdrop-filter: blur(0px) saturate(140%) !important;
          -webkit-backdrop-filter: blur(0px) saturate(140%) !important;
          transition:
              opacity 0.3s cubic-bezier(0.22, 1, 0.36, 1),
              background 0.42s cubic-bezier(0.22, 1, 0.36, 1),
              backdrop-filter 0.42s cubic-bezier(0.22, 1, 0.36, 1),
              -webkit-backdrop-filter 0.42s cubic-bezier(0.22, 1, 0.36, 1);
      }

      #settingsOverlay.shape-transform-enabled.active {
          background: rgba(0, 0, 0, 0.82) !important;
          backdrop-filter: blur(24px) saturate(160%) !important;
          -webkit-backdrop-filter: blur(24px) saturate(160%) !important;
      }

      #settingsOverlay.shape-transform-enabled.closing {
          background: rgba(0, 0, 0, 0) !important;
          backdrop-filter: blur(0px) saturate(140%) !important;
          -webkit-backdrop-filter: blur(0px) saturate(140%) !important;
      }

  body.settings-btn-expanding #settingsMainBtn {
      position: fixed !important;
      left: var(--shape-x, 16px) !important;
      top: var(--shape-y, 16px) !important;
      width: var(--shape-w, 160px) !important;
      height: var(--shape-h, 42px) !important;
      padding: 0 !important;
      border-radius: var(--shape-radius, 12px) !important;
      z-index: 170000 !important;
      font-size: 0 !important;
      color: transparent !important;
      border-color: rgba(255, 255, 255, 0.15) !important;
      background: rgba(0, 0, 0, 0.92) !important;
      box-shadow: none !important;
      pointer-events: none !important;
      transition:
          left var(--shape-open-duration) cubic-bezier(0.2, 0.85, 0.22, 1),
          top var(--shape-open-duration) cubic-bezier(0.2, 0.85, 0.22, 1),
          width var(--shape-open-duration) cubic-bezier(0.2, 0.85, 0.22, 1),
          height var(--shape-open-duration) cubic-bezier(0.2, 0.85, 0.22, 1),
          border-radius var(--shape-open-duration) cubic-bezier(0.2, 0.85, 0.22, 1),
          background-color 260ms cubic-bezier(0.22, 1, 0.36, 1);
  }

  body.settings-btn-expanding.settings-btn-expanded #settingsMainBtn {
      left: 0 !important;
      top: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      border-radius: 0 !important;
  }

  #settingsOverlay.shape-transform-enabled .settings-wrapper {
      opacity: 0;
      transform: translateY(14px);
      transition:
          opacity 280ms cubic-bezier(0.22, 1, 0.36, 1),
          transform 280ms cubic-bezier(0.22, 1, 0.36, 1);
  }

  #settingsOverlay.shape-transform-enabled.active .settings-wrapper {
      opacity: 1;
      transform: translateY(0);
      transition-delay: 430ms;
  }

  #settingsOverlay.shape-transform-enabled.closing .settings-wrapper {
      opacity: 0;
      transform: translateY(8px);
      transition-delay: 0ms;
  }



    .top-center-alert {
        left: 0;
        right: 0;
        width: 100%;
        min-width: 0;
        max-width: 100%;
        padding: calc(env(safe-area-inset-top, 0px) + 8px) 12px 10px;
        border-radius: 0 0 12px 12px;
        gap: 8px;
        align-items: flex-start;
        justify-content: space-between;
        white-space: normal;
        overflow-wrap: anywhere;
        word-break: break-word;
    }

    .top-center-alert.show {
        transform: translateY(0);
    }

    .top-center-alert > span {
        flex: 1 1 auto;
        min-width: 0;
        font-size: 12px;
        line-height: 1.35;
    }

    .close-alert-btn {
        margin-left: 0;
        width: 40px;
        height: 40px;
        min-width: 40px;
        min-height: 40px;
        flex: 0 0 40px;
        font-size: 24px;
        border-radius: 999px;
        align-self: flex-start;
        padding: 0;
        touch-action: manipulation;
    }

    .settings-wrapper {
        width: 100%;
        max-width: none;
        height: 100%;
      padding: calc(env(safe-area-inset-top, 0px) + 62px) 20px calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 28px);
        overflow-y: auto;
    }

    /* Keep preference toggle geometry stable on phone */
    .pref-info {
        flex: 1 1 auto;
        min-width: 0;
    }

    .switch {
        flex: 0 0 44px;
        width: 44px;
        min-width: 44px;
        height: 24px;
    }

    .slider {
        overflow: hidden;
    }

    .close-overlay {
        position: fixed;
        top: calc(env(safe-area-inset-top, 0px) + 10px);
        right: 10px;
        left: auto;
        width: 42px;
        height: 42px;
        font-size: 30px;
        margin: 0;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 150010;
    }

    .back-btn {
        position: sticky;
        top: 0;
        right: auto;
        z-index: 8;
        margin-bottom: 12px;
        background: rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    /* Math calculator: keep equation rows as flex, not stacked blocks */
    .calculator-content-inner {
        padding: 14px;
    }

    .math-form {
        gap: 12px;
    }

    .math-input {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
        box-sizing: border-box;
        gap: 8px;
        padding: 12px;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.2);
    }

    .math-input input,
    .math-input input[type="number"] {
        flex: 0 1 clamp(52px, 18vw, 82px);
        width: clamp(52px, 18vw, 82px);
        max-width: 100%;
        margin: 0;
        padding: 8px 4px;
        text-align: center;
    }

    .math-buttons {
        flex-wrap: wrap;
    }

    .math-buttons .btn-primary,
    .math-buttons .btn-small {
        flex: 1 1 140px;
    }

    /* Fix padding consistency for all 3 equation option pages */
    #linearOneVarPage .calculator-content,
    #quadraticOneVarPage .calculator-content,
    #linearTwoVarPage .calculator-content {
        padding-top: 46px;
    }

    #linearOneVarPage .calculator-content-inner,
    #quadraticOneVarPage .calculator-content-inner,
    #linearTwoVarPage .calculator-content-inner {
        padding: 12px 10px 14px;
    }

    #linearOneVarPage .math-input,
    #quadraticOneVarPage .math-input,
    #linearTwoVarPage .math-input {
        padding: 10px;
    }

    #linearOneVarPage .math-result,
    #quadraticOneVarPage .math-result,
    #linearTwoVarPage .math-result,
    #linearOneVarPage .math-steps,
    #quadraticOneVarPage .math-steps,
    #linearTwoVarPage .math-steps {
        margin-top: 8px;
        padding: 12px;
    }
}

@media screen and (max-width: 480px) {
    :root {
        --bottom-nav-height: 78px;
    }

    .sidebar {
        left: 0;
        right: 0;
        width: 100%;
        height: calc(var(--bottom-nav-height) + var(--safe-area-bottom)) !important;
        min-height: calc(var(--bottom-nav-height) + var(--safe-area-bottom)) !important;
        padding: 2px calc(env(safe-area-inset-right, 0px) + 4px) calc(var(--safe-area-bottom) + 2px) calc(env(safe-area-inset-left, 0px) + 4px);
    }

    .nav-list {
        gap: 3px;
    }

    .nav-link {
        min-height: 40px !important;
        font-size: 0.54rem;
        padding: 2px 1px;
    }

    .snackbar {
        width: 100%;
        max-width: 100%;
        padding: 9px 12px;
        font-size: 0.9rem;
    }

    .close-overlay {
        top: calc(env(safe-area-inset-top, 0px) + 8px);
        right: 8px;
        width: 40px;
        height: 40px;
        font-size: 28px;
    }

    .top-center-alert {
        left: 0;
        right: 0;
        max-width: 100%;
        padding: 9px 10px;
        gap: 6px;
        border-radius: 0 0 10px 10px;
    }

    .top-center-alert > span {
        font-size: 11.5px;
        line-height: 1.3;
    }

    .calculator-content-inner {
        padding: 12px;
    }

    .math-input {
        padding: 10px;
        gap: 6px;
    }

    .math-input input,
    .math-input input[type="number"] {
        flex-basis: clamp(46px, 20vw, 72px);
        width: clamp(46px, 20vw, 72px);
    }

    #linearOneVarPage .calculator-content-inner,
    #quadraticOneVarPage .calculator-content-inner,
    #linearTwoVarPage .calculator-content-inner {
        padding: 10px 8px 12px;
    }

    #linearOneVarPage .math-input,
    #quadraticOneVarPage .math-input,
    #linearTwoVarPage .math-input {
        padding: 8px;
    }
}
  </style>
</head>
<body class="dark-theme"> 
    <div id="safeModeStatus" class="safe-mode-status">Safe Mode Enabled</div>
    <div id="recoveryModeStatus" class="recovery-mode-status" aria-live="polite">Recovery Mode Active  Stabilizing ArchOS Terminal</div>

    <div id="safeModeDialog" class="safe-mode-dialog">
    <div class="dialog-content">
      <h3>Disable Safe Mode?</h3>
      <p>You've clicked the status indicator three times. Are you sure you want to disable Safe Mode?</p>
      <div class="dialog-buttons">
        <button id="disableYesBtn" class="dialog-btn yes">Yes</button>
        <button id="disableNoBtn" class="dialog-btn no">No</button>
      </div>
    </div>
  </div>

  <div id="firstTimePerfOverlay" class="first-time-perf-overlay" aria-hidden="true">
    <div class="first-time-perf-window" role="dialog" aria-modal="true" aria-labelledby="firstTimePerfTitle">
      <h3 id="firstTimePerfTitle">Would you like to enable Performance Mode?</h3>
      <p>Performance Mode reduces visual effects for smoother behavior on slower devices. You can change this later in Settings &gt; Preferences.</p>
      <div class="first-time-perf-actions">
        <button id="firstTimePerfYes" class="first-time-perf-btn yes">Yes</button>
        <button id="firstTimePerfNo" class="first-time-perf-btn no">No</button>
      </div>
    </div>
  </div>

  <div id="intro-screen" class="intro-overlay">
      <div class="intro-content">
          <h1 id="intro-logo">ArchOS </h1>
          <div id="intro-loader" class="loader hidden"></div>
      </div>
  </div>

  <!-- <div id="passwordOverlay" class="glass-overlay">
    <div class="glass-card login-box">
      <h2>Access Restricted</h2>
      <p>Enter the access key to continue.</p>
      <input type="password" id="passwordInput" placeholder="Password..." autocomplete="off">
      <button id="unlockBtn" class="btn-primary">Unlock System</button>
    </div>
  </div> -->

  <div id="snackbar-container"></div>

  <div class="app-container">

    <nav class="sidebar glass-panel">
      <div class="logo">PLD Helper</div>
      <ul class="nav-list">
        <li><button class="nav-link active" data-tab="home">Home</button></li>
        <li><button class="nav-link" data-tab="update">Updates</button></li>
        <!-- <li><button class="nav-link" data-tab="preset">Preset</button></li> -->
        <!-- <li><button class="nav-link" data-tab="game">Cookie Clicker</button></li> -->
        <li><button class="nav-link" data-tab="math">Math Calculator</button></li>
      </ul>

      <div class="sidebar-footer">
        <button id="settingsMainBtn" class="btn-settings-toggle"> Settings</button>
    </div>
    </nav>

    <div id="settingsOverlay" class="full-page-overlay">
      <button class="close-overlay" id="closeSettings"></button>

      <div class="settings-wrapper">
          <div id="settingsMainMenu" class="settings-content-box">
              <h1 class="settings-title">System Settings</h1>
              <div class="settings-grid">
                  <button class="menu-item-large" id="menuCommand">
                      <span class="icon"></span>
                      <div class="text-group">
                          <strong>Terminal</strong>
                          <span>Execute system codes</span>
                      </div>
                  </button>
                  <!-- <button class="menu-item-large" id="menuLock">
                      <span class="icon"></span>
                      <div class="text-group">
                          <strong>Lock</strong>
                          <span>Secure your session</span>
                      </div>
                  </button> -->
                  <button class="menu-item-large" id="menuSubSettings">
                      <span class="icon"></span>
                      <div class="text-group">
                          <strong>Preferences</strong>
                          <span>Performance & UI</span>
                      </div>
                  </button>
                  <button class="menu-item-large" id="menuTranslate">
                      <span class="icon"></span>
                      <div class="text-group">
                          <strong>Translate</strong>
                          <span>Language settings</span>
                      </div>
                  </button>
                  <button class="menu-item-large" id="menuUpdateCheck">
                      <span class="icon"></span>
                      <div class="text-group">
                          <strong>Check Updates</strong>
                          <span>System version info</span>
                      </div>
                  </button>
              </div>
          </div>

          <div id="pagePrefs" class="settings-content-box hidden-page">
            <button class="back-btn" id="prefsBackBtn"> System Menu</button>
            <h2 class="settings-section-title">System Preferences</h2>

            <div class="pref-container">
                <div class="pref-card">
                    <div class="pref-info">
                        <div class="pref-icon"></div>
                        <div class="pref-text">
                            <strong>Performance Mode</strong>
                            <span>Disables glass blurs and animations for low-end CPUs.</span>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="perfToggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="pref-card disabled">
                    <div class="pref-info">
                        <div class="pref-icon"></div>
                        <div class="pref-text">
                            <strong>System Notifications</strong>
                            <span>Toggle snackbar alerts (Coming Soon).</span>
                        </div>
                    </div>
                    <div class="lock-status"></div>
                </div>

                <div class="pref-card">
                    <div class="pref-info">
                        <div class="pref-icon"></div>
                        <div class="pref-text">
                            <strong>Motion Fidelity</strong>
                            <span>Enable Apple-style transitions, depth, and micro-animations.</span>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="motionToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

          <div id="pageCommand" class="settings-content-box hidden-page">
              <button class="back-btn" id="commandBackBtn"> System Menu</button>
              <div class="terminal-header">
                  <span class="dot red"></span>
                  <span class="dot yellow"></span>
                  <span class="dot green"></span>
                  <span class="terminal-title">bash  system-terminal</span>
              </div>
              <div class="terminal-body">
                  <div class="command-line">
                      <span class="prompt">user@pld-helper:~$</span>
                      <input type="text" id="commandInput" placeholder="enter_auth_code" autofocus>
                  </div>
                  <button id="commandBtn" class="btn-execute">Execute Command</button>
              </div>
          </div>

          <div id="pageTranslate" class="settings-content-box hidden-page">
            <button class="back-btn" id="translateBackBtn"> System Menu</button>
            <h2 class="settings-section-title">Language Settings</h2>

            <div class="translate-container">
                <div class="translate-card" id="englishLangCard">
                    <div class="translate-info">
                        <div class="translate-icon"></div>
                        <div class="translate-text">
                            <strong>English</strong>
                            <span>Switch to English interface</span>
                        </div>
                    </div>
                    <div class="language-selector">
                        <div class="language-name">English</div>
                        <div class="checkmark" id="englishCheck"></div>
                    </div>
                </div>

                <div class="translate-card" id="chineseLangCard">
                    <div class="translate-info">
                        <div class="translate-icon"></div>
                        <div class="translate-text">
                            <strong>Chinese</strong>
                            <span></span>
                        </div>
                    </div>
                    <div class="language-selector">
                        <div class="language-name"></div>
                        <div class="checkmark" id="chineseCheck"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pageUpdateCheck" class="settings-content-box hidden-page">
            <button class="back-btn" id="updateCheckBackBtn"> System Menu</button>
            <h2 class="settings-section-title">Check for Updates</h2>

            <div class="update-card">
                <h3>System Version Information</h3>
                <p class="update-info">Current Version: <span id="currentVersion" class="update-badge">v6</span></p>
                <div class="update-action">
                    <button id="checkUpdateBtn" class="update-check-btn">Check Now</button>
                </div>
                <div id="updateResult" class="update-result"></div>
            </div>
        </div>
      </div>
  </div>

    <main class="main-content">

      <header class="header glass-panel">
        <div class="header-version-table" aria-label="Version information">
          <div class="header-version-cell"><span class="header-version-label">Version</span><span class="badge">v2.0</span></div>
          <div class="header-version-cell"><span class="header-version-label">Archivable Website</span><span class="badge">v3.9.2b</span></div>
          <div class="header-version-cell"><span class="header-version-label">ArchOS</span><span class="badge">v7</span></div>
          <!-- <div class="header-version-cell"><span class="header-version-label">ArchEngine</span><span class="badge">v6</span></div> -->
        </div>
        <input type="search" id="searchBox" placeholder="This feature is wip" class="search-bar">
      </header>

      <section id="home" class="tab-content">
        <div class="glass-card content-item">
          <p class="text">Currently this website only supports PC. (Chromebook / Windows / Macbooks etc.)</p>
        </div>
        <div class="glass-card content-item">
          <h1>Welcome Back</h1>
          <p>This is the modernized version of the PLD Helper. The interface has been upgraded to a fluent design language.</p>
          <hr>
          <p class="text-muted">Select a tab from the sidebar to begin.</p>
        </div>
      </section>

      <section id="resources" class="tab-content hidden">
        <div class="glass-card content-item">
          <h2>LefiJS Library</h2>
          <p>A lightweight JavaScript library for modern interactions.</p>
          <button id="downloadBtn" class="btn-primary">Download v1.0</button>
        </div>
      </section>

      <section id="about" class="tab-content hidden">
        <div class="glass-card content-item">
          <h2>About</h2>
          <p>Created by Lefi. Designed for performance and aesthetics.</p>
        </div>
      </section>

      <section id="update" class="tab-content hidden">
        <div class="glass-card content-item">
            <span class="badge red">Latest</span>
            <h2>Update v3.9.2</h2>
            <ul class="update-list">
                <li>Content Disabled / Removed</li>
            </ul>
        </div>
        <!-- <div class="glass-card content-item">
          <div class="update-check-card">
            <h3>Check for Updates</h3>
            <div id="updateStatus" class="update-status">Checking...</div>
            <p class="update-info">Current Version: <span id="currentVersion" class="update-badge">v6</span></p>
            <button id="checkUpdateBtn" class="btn-primary">Check Now</button>
          </div>
        </div> -->
      </section>

      <section id="preset" class="tab-content hidden">
        <div class="glass-card content-item">
          <h2 class="text-danger">CONTENT REMOVED</h2>
          <p>This feature is currently disabled by the developer.</p>
        </div>
      </section>

      <section id="game" class="tab-content hidden">
        <div class="game-dashboard">

          <div class="glass-card stats-panel">
            <h3>Cookie Corp</h3>
            <div class="big-stat"><span id="cookieCount">0</span> </div>
            <div class="sub-stat">per second: <span id="cpsCount">0</span></div>
            <button id="cookieBtn" class="btn-primary big-btn">Click Me!</button>
          </div>

          <div class="glass-card upgrades-panel">
            <h3>Marketplace</h3>
            <div class="upgrade-grid">
              <table class="modern-table">
                <thead>
                    <tr>
                        <tr>
                            <th>Upgrade</th>
                            <th>Cost</th>
                            <th>Owned</th>
                            <th>Action</th>
                        </tr>
                    </tr>
                </thead>
                <tbody id="upgradeTableBody">
                    </tbody>
              </table>
            </div>
          </div>

          <div class="glass-card achievements-panel">
            <h3>Achievements</h3>
            <div class="achievements-grid" id="achievementGrid">
              <!-- Achievements will be populated by JavaScript -->
            </div>
          </div>

        </div>
      </section>

      <section id="math" class="tab-content hidden">
        <div id="mathHome" class="math-calculator">
          <button class="math-button" id="linearOneVarBtn">Linear Equation of one Variable</button>
          <button class="math-button" id="quadraticOneVarBtn">Quadratic Equation of one Variable</button>
          <button class="math-button" id="linearTwoVarBtn">Linear Equation in two Variable</button>
        </div>

        <div id="linearOneVarPage" class="math-calculator hidden">
          <div class="calculator-content">
            <button class="calculator-back-btn" id="linearOneVarBackBtn"> Back</button>
            <div class="calculator-content-inner">
              <h2>Linear Equation of one Variable</h2>
              <div class="calculator-form math-form">
                <div class="math-input">
                  <input type="number" id="linearA" placeholder="a" step="any">x + 
                  <input type="number" id="linearB" placeholder="b" step="any"> = 
                  <input type="number" id="linearC" placeholder="c" step="any">
                </div>
                <div class="math-buttons">
                  <button class="btn-primary" id="linearOneVarCalcBtn">Calculate</button>
                  <button class="btn-small danger" id="linearOneVarClearBtn">Clear</button>
                </div>
                <div id="linearOneVarResult" class="math-result"></div>
                <div id="linearOneVarSteps" class="math-steps"></div>
              </div>
            </div>
          </div>
        </div>

        <div id="quadraticOneVarPage" class="math-calculator hidden">
          <div class="calculator-content">
            <button class="calculator-back-btn" id="quadraticOneVarBackBtn"> Back</button>
            <div class="calculator-content-inner">
              <h2>Quadratic Equation of one Variable</h2>
              <div class="calculator-form math-form">
                <div class="math-input">
                  <input type="number" id="quadA" placeholder="a" step="any">x<sup>2</sup> + 
                  <input type="number" id="quadB" placeholder="b" step="any">x + 
                  <input type="number" id="quadC" placeholder="c" step="any"> = 0
                </div>
                <div class="math-buttons">
                  <button class="btn-primary" id="quadraticOneVarCalcBtn">Calculate</button>
                  <button class="btn-small" id="quadraticOneVarFactorBtn">Factorise</button>
                  <button class="btn-small danger" id="quadraticOneVarClearBtn">Clear</button>
                </div>
                <div id="quadraticOneVarResult" class="math-result"></div>
                <div id="quadraticOneVarSteps" class="math-steps"></div>
              </div>
            </div>
          </div>
        </div>

        <div id="linearTwoVarPage" class="math-calculator hidden">
          <div class="calculator-content">
            <button class="calculator-back-btn" id="linearTwoVarBackBtn"> Back</button>
            <div class="calculator-content-inner">
              <h2>Linear Equation in two Variable</h2>
              <div class="calculator-form math-form">
                <div class="math-input">
                  <input type="number" id="eq1A" placeholder="a1" step="any">x + 
                  <input type="number" id="eq1B" placeholder="b1" step="any">y = 
                  <input type="number" id="eq1C" placeholder="c1" step="any">
                </div>
                <div class="math-input">
                  <input type="number" id="eq2A" placeholder="a2" step="any">x + 
                  <input type="number" id="eq2B" placeholder="b2" step="any">y = 
                  <input type="number" id="eq2C" placeholder="c2" step="any">
                </div>
                <div class="math-buttons">
                  <button class="btn-primary" id="linearTwoVarCalcBtn">Calculate</button>
                  <button class="btn-small danger" id="linearTwoVarClearBtn">Clear</button>
                </div>
                <div id="linearTwoVarResult" class="math-result"></div>
                <div id="linearTwoVarSteps" class="math-steps"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="achievements" class="tab-content hidden">
        <div class="glass-card content-item">
          <h2>Achievements</h2>
          <div class="achievement-grid" id="achievementTabGrid">
            <!-- Achievements will be populated by JavaScript -->
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Terminal Overlay -->
  <div id="terminalOverlay" class="terminal-overlay">
    <div class="terminal-content console-font">
      <div id="terminalText">Entering Terminal...</div>
      <div id="terminalLoader" class="terminal-loader"></div>
      <div id="terminalOptions" class="terminal-options" style="display:none;">
        <div class="terminal-title">ArchOS Terminal v3</div>
        <div class="terminal-command-box">
          <div class="terminal-command-row">
            <input id="terminalRootCommandInput" class="terminal-command-input" type="text" spellcheck="false" placeholder="">
            <button id="terminalRootCommandBtn" class="terminal-command-btn" type="button">Run</button>
          </div>
          <div id="terminalRootFeedback" class="terminal-command-feedback" aria-live="polite"></div>
        </div>
        <div class="terminal-option root-editor" id="rootEditorOption">Open Root Editor</div>
        <div class="terminal-option" id="clearOption">Clear localstorage</div>
        <div class="terminal-option safe-mode" id="safeModeOption">Safe Mode</div>
        <div class="terminal-option test-mode" id="testModeOption">Test Mode</div>
        <div class="terminal-option" id="exitOption">Exit Terminal</div>
      </div>
      <div id="terminalClearOptions" class="terminal-options" style="display:none;">
        <div class="terminal-option" id="clearNowOption">Clear Now</div>
        <div class="terminal-option" id="backOption">Back</div>
      </div>
      <div id="terminalProcessing" class="terminal-processing" style="display:none;">
        Processing <span id="countdownDisplay" class="countdown-display">[0]</span>
      </div>
      <div id="terminalSuccess" class="terminal-success" style="display:none;">
        Successfully Cleared
      </div>
      <div id="terminalBackButton" class="terminal-back-btn" style="display:none;">
        Back to Terminal
      </div>
      <div id="terminalQuit" class="terminal-quit" style="display:none;">Quitting Terminal...</div>
      <div id="terminalQuitLoader" class="terminal-quit-loader" style="display:none;"></div>
    </div>
  </div>

  <!-- Language Change Overlay -->
  <div id="languageChangeOverlay" class="language-change-overlay">
    <div class="language-change-text" id="languageChangeText">Changing Language</div>
    <div class="language-change-loader"></div>
  </div>

  <div id="rootEditorModal" class="root-editor-modal" aria-hidden="true">
    <div class="root-editor-card">
      <h3>ArchOS Root Editor (User Layer)</h3>
      <p>Only user-layer fields are editable. Core scripts remain protected.</p>
      <div class="root-editor-grid">
        <label>Welcome title
          <input id="rootEditorWelcomeTitle" type="text" maxlength="80">
        </label>
        <label>Welcome description
          <textarea id="rootEditorWelcomeText" rows="3" maxlength="240"></textarea>
        </label>
        <label>Accent color
          <input id="rootEditorAccentColor" type="color" value="#667eea">
        </label>
        <label>Custom command phrase
          <input id="rootEditorCommandName" type="text" maxlength="40" placeholder="mycmd">
        </label>
        <label>Custom command response
          <textarea id="rootEditorCommandResponse" rows="3" maxlength="220"></textarea>
        </label>
        <label>Layout density
          <select id="rootEditorLayoutDensity">
            <option value="comfortable">Comfortable</option>
            <option value="compact">Compact</option>
          </select>
        </label>
      </div>
      <div class="root-editor-actions">
        <button id="rootEditorSaveBtn" type="button">Save & Apply</button>
        <button id="rootEditorResetBtn" class="danger" type="button">Reset Customizations</button>
        <button id="rootEditorCloseBtn" type="button">Close</button>
      </div>
      <div id="rootEditorAuditLog" class="root-editor-log">No changes yet.</div>
    </div>
  </div>

  <script>
    // ==========================================
    // 1. GLOBAL STATE & CONFIGURATION
    // ==========================================
    let cookies = 0;
    let clickPower = 1;
    let totalCookiesEarned = 0;
    let devMode = false;
    let homeClickCount = 0;
    let countdownInterval = null;
    let terminalActivated = false;
    let currentLanguage = 'en';
    let isAccessLocked = false; // Security lock state
    let isSafeModeActive = false;
    let safeModeClickCount = 0;
    const storageFacade = {
        local: {
            getItem(key) { try { return window.localStorage ? window.localStorage.getItem(key) : null; } catch (_) { return null; } },
            setItem(key, value) { try { if (window.localStorage) window.localStorage.setItem(key, value); } catch (_) {} },
            removeItem(key) { try { if (window.localStorage) window.localStorage.removeItem(key); } catch (_) {} },
            clear() { try { if (window.localStorage) window.localStorage.clear(); } catch (_) {} }
        },
        session: {
            getItem(key) { try { return window.sessionStorage ? window.sessionStorage.getItem(key) : null; } catch (_) { return null; } },
            setItem(key, value) { try { if (window.sessionStorage) window.sessionStorage.setItem(key, value); } catch (_) {} }
        }
    };

    const ARCH_ROOT_SESSION_KEY = 'archRootSessionV1';
    const ARCH_USER_LAYER_KEY = 'archUserLayerConfigV1';
    const ARCH_AUDIT_LOG_KEY = 'archUserLayerAuditV1';
    let originalPerfMode = storageFacade.local.getItem('perfMode');
    let isRootSession = storageFacade.session.getItem(ARCH_ROOT_SESSION_KEY) === 'enabled';
    const userLayerDefaults = {
        welcomeTitle: 'Welcome Back',
        welcomeText: 'This is the modernized version of the PLD Helper. The interface has been upgraded to a fluent design language.',
        accentColor: '#667eea',
        commandName: '',
        commandResponse: '',
        layoutDensity: 'comfortable'
    };
    let scrollRevealObserver = null;
    let activeTabSection = null;
    let tabTransitionTimer = null;
    let switchTabWithTransitionFn = null;
    let updateMobileNavIndicatorFn = null;
    let mouseGlowBound = false;
    let motionController = null;
    let motionToggleRafPending = false;
      let commandHistory = [];
      const ARCH_RECOVERY_KEY = 'archRecoveryV1';
      const ARCH_RECOVERY_MAX_HISTORY = 30;
      const ARCH_MONITOR_INTERVAL_MS = 5000;
      let recoveryModeActive = false;
      let watchdogMonitorTimer = null;
      // const perfAutoState = {
      //      enabled: false,
      //  droppedFramesSeconds: 0,
      //      stableSeconds: 0,
      //      lastTimestamp: 0,
      //      autoForced: false,
      //      profile: 'normal'
      //  };

    // Upgrades Data
    const upgrades = {
        budgetMouse: { name: "Budget Mouse", cost: 100, own: 0, power: 1, type: 'click' },
        officeMouse: { name: "Office Mouse", cost: 500, own: 0, power: 5, type: 'click' },
        gamingMouse: { name: "Gaming Mouse", cost: 1000, own: 0, power: 25, type: 'click' },
        farmer: { name: "Cookie Farmer", cost: 150, own: 0, cps: 1, type: 'auto' },
        factory: { name: "Cookie Factory", cost: 1000, own: 0, cps: 10, type: 'auto' },
        ceo: { name: "CEO", cost: 100000, own: 0, cps: 500, type: 'auto' }
    };

    // Achievement Data
    let achievements = [
        { id: 'first_click', title: 'First Click', desc: 'Click your first cookie', icon: '', goal: 1, progress: 0, unlocked: false },
        { id: 'hundred_cookies', title: 'Hundred Club', desc: 'Bake 100 cookies', icon: '', goal: 100, progress: 0, unlocked: false },
        { id: 'first_upgrade', title: 'Upgrader', desc: 'Purchase your first upgrade', icon: '', goal: 1, progress: 0, unlocked: false },
        { id: 'ten_upgrades', title: 'Big Spender', desc: 'Own 10 upgrades', icon: '', goal: 10, progress: 0, unlocked: false },
        { id: 'one_thousand', title: 'Thousandaire', desc: 'Reach 1000 cookies', icon: '', goal: 1000, progress: 0, unlocked: false },
        { id: 'click_master', title: 'Click Master', desc: 'Click 1000 times', icon: '', goal: 1000, progress: 0, unlocked: false },
        { id: 'autoclicker', title: 'Autoclicker', desc: 'Have 10 cookies per second', icon: '', goal: 10, progress: 0, unlocked: false },
        { id: 'cookie_connoisseur', title: 'Connoisseur', desc: 'Reach 10,000 cookies', icon: '', goal: 10000, progress: 0, unlocked: false }
    ];

    // Translations
    const translations = {
        en: {
            first_click_title: 'First Click', first_click_desc: 'Click your first cookie',
            hundred_cookies_title: 'Hundred Club', hundred_cookies_desc: 'Bake 100 cookies',
            first_upgrade_title: 'Upgrader', first_upgrade_desc: 'Purchase your first upgrade',
            ten_upgrades_title: 'Big Spender', ten_upgrades_desc: 'Own 10 upgrades',
            one_thousand_title: 'Thousandaire', one_thousand_desc: 'Reach 1000 cookies',
            click_master_title: 'Click Master', click_master_desc: 'Click 1000 times',
            autoclicker_title: 'Autoclicker', autoclicker_desc: 'Have 10 cookies per second',
            cookie_connoisseur_title: 'Connoisseur', cookie_connoisseur_desc: 'Reach 10,000 cookies',
            language_change_text: 'Changing Language', changing_language_text: ''
        },
        zh: {
            first_click_title: '', first_click_desc: '',
            hundred_cookies_title: '', hundred_cookies_desc: '100',
            first_upgrade_title: '', first_upgrade_desc: '',
            ten_upgrades_title: '', ten_upgrades_desc: '10',
            one_thousand_title: '', one_thousand_desc: '1000',
            click_master_title: '', click_master_desc: '1000',
            autoclicker_title: '', autoclicker_desc: '10',
            cookie_connoisseur_title: '', cookie_connoisseur_desc: '10,000',
            language_change_text: '', changing_language_text: 'Changing Language'
        }
    };

    // ==========================================
    // 2. CORE HELPER FUNCTIONS
    // ==========================================

    function getTranslation(key) {
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
            return translations[currentLanguage][key];
        }
        return translations['en'][key] || key;
    }

    function showSnackbar(msg) {
        const container = document.getElementById("snackbar-container");
        if (!container) return;
        const sb = document.createElement("div");
        sb.className = "snackbar";
        sb.innerText = msg;
        container.appendChild(sb);
        setTimeout(() => sb.remove(), 3000);
    }

    function isPerformanceModeEnabled() {
        return document.body.classList.contains('low-spec');
    }

    function setPerformanceMode(enabled, { notify = true, syncToggle = true } = {}) {
        if (enabled) {
            document.body.classList.add('low-spec');
            setupCardTilt();
            storageFacade.local.setItem('perfMode', 'enabled');
            if (notify) showSnackbar("Performance Mode Enabled");
        } else {
            document.body.classList.remove('low-spec');
            setupMouseGlow();
            storageFacade.local.setItem('perfMode', 'disabled');
            if (notify) showSnackbar("Performance Mode Disabled");
        }

        if (syncToggle) {
            const perfToggle = document.getElementById('perfToggle');
            if (perfToggle) perfToggle.checked = enabled;
        }

        if (motionController) motionController.setPerformanceMode(enabled);

        // refreshTestModeWindowPerformanceLabel();
    }


    class MotionController {
        constructor() {
            this.enabled = storageFacade.local.getItem('motionMode') !== 'disabled';
            this.performanceMode = isPerformanceModeEnabled();
            this.reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            this.profile = 'full';
            this.rafQueue = new Set();
            this.fpsSamples = [];
            this.lastFrameTime = 0;
            this.performanceDowngraded = false;
            this.pointerHandler = this.onPointerMove.bind(this);
            this.orientationHandler = this.onOrientation.bind(this);
            this.visibilityHandler = this.onVisibilityChange.bind(this);
            this.reducedMotionListener = null;
            this.particleLayer = null;
            this.particles = [];
            this.init();
        }

        init() {
            this.updateProfile();
            this.bindEnvironmentListeners();
            this.attachParallaxHandlers();
            this.ensureParticleLayer();
            this.monitorFps();
        }

        bindEnvironmentListeners() {
            const reducedMotionMedia = window.matchMedia('(prefers-reduced-motion: reduce)');
            this.reducedMotionListener = (event) => {
                this.reduceMotion = event.matches;
                this.updateProfile();
            };
            if (typeof reducedMotionMedia.addEventListener === 'function') {
                reducedMotionMedia.addEventListener('change', this.reducedMotionListener);
            } else if (typeof reducedMotionMedia.addListener === 'function') {
                reducedMotionMedia.addListener(this.reducedMotionListener);
            }
            document.addEventListener('visibilitychange', this.visibilityHandler, { passive: true });
        }

        onVisibilityChange() {
            if (document.hidden) {
                this.fpsSamples = [];
                this.lastFrameTime = 0;
            }
        }

        setEnabled(enabled) {
            this.enabled = !!enabled;
            storageFacade.local.setItem('motionMode', this.enabled ? 'enabled' : 'disabled');
            this.updateProfile();
        }

        setPerformanceMode(enabled) {
            this.performanceMode = !!enabled;
            this.updateProfile();
        }

        updateProfile() {
            const shouldReduce = !this.enabled || this.performanceMode || this.reduceMotion || this.performanceDowngraded;
            this.profile = shouldReduce ? 'reduced' : 'full';
            document.body.classList.toggle('motion-full', this.profile === 'full');
            document.body.classList.toggle('motion-reduced', this.profile !== 'full');
            this.ensureParticleLayer();
        }

        runFrame(task) {
            this.rafQueue.add(task);
            if (this.rafScheduled) return;
            this.rafScheduled = true;
            requestAnimationFrame(() => {
                this.rafQueue.forEach((fn) => fn());
                this.rafQueue.clear();
                this.rafScheduled = false;
            });
        }

        attachParallaxHandlers() {
            window.addEventListener('pointermove', this.pointerHandler, { passive: true });
            window.addEventListener('scroll', () => this.handleParallaxFromScroll(), { passive: true });
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', this.orientationHandler, { passive: true });
            }
        }

        onPointerMove(event) {
            if (this.profile !== 'full') return;
            const x = (event.clientX / Math.max(window.innerWidth, 1)) * 100;
            const y = (event.clientY / Math.max(window.innerHeight, 1)) * 100;
            this.applyParallax(x, y);
        }

        onOrientation(event) {
            if (this.profile !== 'full') return;
            const x = Math.min(100, Math.max(0, 50 + (event.gamma || 0) * 1.4));
            const y = Math.min(100, Math.max(0, 50 + (event.beta || 0) * 0.9));
            this.applyParallax(x, y);
        }

        handleParallaxFromScroll() {
            if (this.profile !== 'full') return;
            const progress = Math.min(1, window.scrollY / Math.max(window.innerHeight * 2, 1));
            const y = 40 + (progress * 20);
            this.applyParallax(50, y);
        }

        applyParallax(xPercent, yPercent) {
            this.runFrame(() => {
                const shiftX = ((xPercent - 50) / 50) * 8;
                const shiftY = ((yPercent - 50) / 50) * 8;
                document.documentElement.style.setProperty('--parallax-x', xPercent.toFixed(2));
                document.documentElement.style.setProperty('--parallax-y', yPercent.toFixed(2));
                document.documentElement.style.setProperty('--parallax-shift-x', `${shiftX.toFixed(2)}px`);
                document.documentElement.style.setProperty('--parallax-shift-y', `${shiftY.toFixed(2)}px`);
            });
        }

        ensureParticleLayer() {
            if (!this.particleLayer) {
                this.particleLayer = document.createElement('div');
                this.particleLayer.className = 'particle-layer';
                document.body.appendChild(this.particleLayer);
            }

            if (this.profile !== 'full') {
                this.particleLayer.replaceChildren();
                this.particles = [];
                return;
            }

            if (this.particles.length) return;

            const particleCount = Math.min(18, Math.max(8, Math.round(window.innerWidth / 120)));
            for (let i = 0; i < particleCount; i++) {
                const node = document.createElement('span');
                node.className = 'particle';
                const size = (Math.random() * 3 + 2).toFixed(2);
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                const speed = (Math.random() * 0.2 + 0.06) * (Math.random() > 0.5 ? 1 : -1);
                node.style.setProperty('--size', `${size}px`);
                node.style.transform = `translate3d(${x}px, ${y}px, 0)`;
                this.particleLayer.appendChild(node);
                this.particles.push({ node, x, y, speed });
            }

            this.animateParticles();
        }

        animateParticles() {
            if (this.profile !== 'full' || !this.particles.length) return;
            this.runFrame(() => {
                this.particles.forEach((particle, index) => {
                    particle.y += particle.speed;
                    particle.x += Math.sin((performance.now() / 1200) + index) * 0.08;
                    if (particle.y < -12) particle.y = window.innerHeight + 8;
                    if (particle.y > window.innerHeight + 12) particle.y = -8;
                    if (particle.x < -12) particle.x = window.innerWidth + 8;
                    if (particle.x > window.innerWidth + 12) particle.x = -8;
                    particle.node.style.transform = `translate3d(${particle.x.toFixed(2)}px, ${particle.y.toFixed(2)}px, 0)`;
                });
                this.animateParticles();
            });
        }

        monitorFps() {
            const tick = (time) => {
                if (!this.lastFrameTime) {
                    this.lastFrameTime = time;
                    requestAnimationFrame(tick);
                    return;
                }

                const delta = time - this.lastFrameTime;
                this.lastFrameTime = time;
                if (!delta) {
                    requestAnimationFrame(tick);
                    return;
                }

                const fps = 1000 / delta;
                this.fpsSamples.push(fps);
                if (this.fpsSamples.length > 60) this.fpsSamples.shift();

                if (this.fpsSamples.length >= 35) {
                    const avg = this.fpsSamples.reduce((sum, value) => sum + value, 0) / this.fpsSamples.length;
                    if (avg < 43 && !this.performanceDowngraded) {
                        this.performanceDowngraded = true;
                        this.updateProfile();
                    } else if (avg > 53 && this.performanceDowngraded && !this.performanceMode && this.enabled && !this.reduceMotion) {
                        this.performanceDowngraded = false;
                        this.updateProfile();
                    }
                }

                requestAnimationFrame(tick);
            };
            requestAnimationFrame(tick);
        }
    }

      // function getSafeText(value, maxLength = 200) {
      //     return String(value || '').replace(/[<>]/g, '').trim().slice(0, maxLength);
      // }

      // function captureUILayoutState() {
      //     const activeTab = document.querySelector('.tab-content:not(.hidden)')?.id || 'home';
      //     const settingsOverlay = document.getElementById('settingsOverlay');
      //     return {
      //         activeTab,
      //         settingsOpen: !!(settingsOverlay && settingsOverlay.classList.contains('active')),
      //         bodyClasses: Array.from(document.body.classList)
      //     };
      // }

      // function createRecoverySnapshot(reason = 'periodic') {
      //     return {
      //         savedAt: Date.now(),
      //         reason,
      //         darkTheme: document.body.classList.contains('dark-theme'),
      //         lowSpec: document.body.classList.contains('low-spec'),
      //         safeMode: isSafeModeActive,
      //         language: currentLanguage,
      //         accessLocked: isAccessLocked,
      //         commandHistory: commandHistory.slice(-ARCH_RECOVERY_MAX_HISTORY),
      //         ui: captureUILayoutState(),
      //         data: { cookies, totalCookiesEarned, clickPower, upgrades, achievements }
      //     };
      // }

      // function persistStableState(reason = 'periodic') {
      //     try {
      //         const snapshot = createRecoverySnapshot(reason);
      //         localStorage.setItem(ARCH_RECOVERY_KEY, JSON.stringify(snapshot));
      //     } catch (error) {
      //         console.warn('Recovery snapshot failed:', error);
      //     }
      // }

      // function restoreFromSnapshot(snapshot, reason = 'manual') {
      //     if (!snapshot || typeof snapshot !== 'object') return false;

      //     try {
      //         const data = snapshot.data || {};
      //         cookies = Number(data.cookies) || 0;
      //         totalCookiesEarned = Number(data.totalCookiesEarned) || 0;
      //         clickPower = Number(data.clickPower) || 1;

      //         if (data.upgrades && typeof data.upgrades === 'object') {
      //             for (const key in upgrades) {
      //                 if (!data.upgrades[key]) continue;
      //                 upgrades[key].own = Number(data.upgrades[key].own) || 0;
      //                 upgrades[key].cost = Number(data.upgrades[key].cost) || upgrades[key].cost;
      //             }
      //         }
      //         if (Array.isArray(data.achievements)) achievements = data.achievements;

      //         commandHistory = Array.isArray(snapshot.commandHistory)
      //             ? snapshot.commandHistory.slice(-ARCH_RECOVERY_MAX_HISTORY).map(item => getSafeText(item, 80))
      //             : [];

      //         if (snapshot.darkTheme) document.body.classList.add('dark-theme');
      //         else document.body.classList.remove('dark-theme');

      //         setPerformanceMode(!!snapshot.lowSpec, { notify: false, syncToggle: true });
      //         currentLanguage = snapshot.language || currentLanguage;
      //         isAccessLocked = !!snapshot.accessLocked;
      //         document.body.classList.toggle('lock-selection', isAccessLocked);
      //         document.body.classList.toggle('locked-access', isAccessLocked);

      //         updateLanguageSelector();
      //         renderUpgrades();
      //         updateDisplay();
      //         renderAchievements();
      //         showSnackbar(`Recovery: restored stable state (${reason})`);
      //         return true;
      //     } catch (error) {
      //         console.error('Recovery restore failed:', error);
      //         return false;
      //     }
      // }

      // function runAutoFixEngine() {
      //     const repairs = [];

      //     if (!document.documentElement.style.getPropertyValue('--vh')) {
      //         document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
      //         repairs.push('viewport var restored');
      //     }

      //     const requiredNodes = ['settingsOverlay', 'settingsMainBtn', 'snackbar-container'];
      //     for (const id of requiredNodes) {
      //         if (!document.getElementById(id)) repairs.push(`missing #${id}`);
      //     }

      //     if (typeof switchTabWithTransitionFn !== 'function') {
      //         switchTabWithTransitionFn = (sectionId) => {
      //             document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
      //             const target = document.getElementById(sectionId);
      //             if (target) target.classList.remove('hidden');
      //         };
      //         repairs.push('tab switch fallback restored');
      //     }

      //     if (repairs.length) console.warn('Auto-fix engine:', repairs.join(', '));
      //     return repairs;
      // }

      // function setRecoveryMode(active, message = 'Recovery Mode Active  Stabilizing ArchOS Terminal') {
      //     recoveryModeActive = !!active;
      //     const status = document.getElementById('recoveryModeStatus');
      //     if (!status) return;
      //     status.textContent = getSafeText(message, 120);
      //     status.classList.toggle('visible', recoveryModeActive);
      // }

      // function triggerRecovery(reason = 'Unknown failure') {
      //     console.warn('Arch Recovery triggered:', reason);
      //     const repairs = runAutoFixEngine();
      //     if (repairs.length > 0) {
      //         setRecoveryMode(true, `Recovery Mode Active  Auto-fixed ${repairs.length} issue(s)`);
      //         setTimeout(() => setRecoveryMode(false), 2500);
      //         persistStableState('auto-fix');
      //         return;
      //     }

      //     const snapshotRaw = localStorage.getItem(ARCH_RECOVERY_KEY);
      //     const snapshot = snapshotRaw ? JSON.parse(snapshotRaw) : null;
      //     const restored = restoreFromSnapshot(snapshot, reason);
      //     setRecoveryMode(true, restored ? `Recovery Mode Active  Rollback complete (${reason})` : 'Recovery Mode Active  Manual intervention required');

      //     if (!restored) {
      //         enableSafeMode();
      //         const smStatus = document.getElementById('safeModeStatus');
      //         if (smStatus) smStatus.classList.add('visible');
      //     }

      //     setTimeout(() => setRecoveryMode(false), 4500);
      // }

      // function recordCommandHistory(command) {
      //     const clean = getSafeText(command, 80);
      //     if (!clean) return;
      //     commandHistory.push(clean);
      //     if (commandHistory.length > ARCH_RECOVERY_MAX_HISTORY) commandHistory = commandHistory.slice(-ARCH_RECOVERY_MAX_HISTORY);
      // }

      // function validateCommandInput(rawValue) {
      //     const value = String(rawValue || '').trim();
      //     if (!value) return { ok: false, reason: 'Empty command' };
      //     if (value.length > 120) return { ok: false, reason: 'Command too long' };
      //     if (/[^a-zA-Z0-9\s\-_]/.test(value)) return { ok: false, reason: 'Unsupported symbols in command' };
      //     const lowered = value.toLowerCase();
      //     const allowed = ['lightmode', 'blackmode', 'acc unlock', 'acc lock', 'show res', 'wipe-data'];
      //     if (!allowed.includes(lowered)) return { ok: false, reason: 'Unknown command' };
      //     return { ok: true, value: lowered };
      // }

      // function setupArchWatchdog() {
      //     window.addEventListener('error', (event) => {
      //         triggerRecovery(`Runtime: ${getSafeText(event?.message || 'Runtime error', 120)}`);
      //     });

      //     window.addEventListener('unhandledrejection', (event) => {
      //         triggerRecovery(`Promise: ${getSafeText(event?.reason?.message || event?.reason || 'Promise rejection', 120)}`);
      //     });

      //     persistStableState('boot');
      //     if (watchdogMonitorTimer) clearInterval(watchdogMonitorTimer);
      //     watchdogMonitorTimer = setInterval(() => {
      //         const required = ['settingsOverlay', 'settingsMainBtn', 'commandInput', 'commandBtn'];
      //         const missing = required.filter(id => !document.getElementById(id));
      //         if (missing.length) return triggerRecovery(`Missing core nodes: ${missing.join(', ')}`);
      //         persistStableState('watchdog');
      //     }, ARCH_MONITOR_INTERVAL_MS);
      // }

      // function setupPerformanceAutoSwitch() {
      //     const lowSpecDevice =
      //         (typeof navigator.deviceMemory === 'number' && navigator.deviceMemory <= 4) ||
      //         (typeof navigator.hardwareConcurrency === 'number' && navigator.hardwareConcurrency <= 4);

      //     perfAutoState.profile = lowSpecDevice ? 'low' : 'normal';
      //     perfAutoState.enabled = true;
      //     perfAutoState.lastTimestamp = 0;

      //     if (lowSpecDevice && !isPerformanceModeEnabled()) {
      //         setPerformanceMode(true, { notify: false, syncToggle: true });
      //         perfAutoState.autoForced = true;
      //         showSnackbar('Performance Auto Switch: Enabled for this device');
      //     }

      //     const tick = (timestamp) => {
      //         if (!perfAutoState.enabled) return;

      //         if (perfAutoState.lastTimestamp > 0) {
      //             const delta = timestamp - perfAutoState.lastTimestamp;
      //             const fps = delta > 0 ? 1000 / delta : 60;

      //             if (fps < 25) {
      //                 perfAutoState.droppedFramesSeconds += delta / 1000;
      //                 perfAutoState.stableSeconds = 0;
      //             } else if (fps > 50) {
      //                 perfAutoState.stableSeconds += delta / 1000;
      //                 perfAutoState.droppedFramesSeconds = Math.max(0, perfAutoState.droppedFramesSeconds - (delta / 1000) * 0.8);
      //             }

      //             if (perfAutoState.droppedFramesSeconds >= 2.5 && !isPerformanceModeEnabled()) {
      //                 setPerformanceMode(true, { notify: false, syncToggle: true });
      //                 perfAutoState.autoForced = true;
      //                 perfAutoState.droppedFramesSeconds = 0;
      //                 showSnackbar('Performance Auto Switch: Lag detected, optimized mode enabled');
      //             }

      //             if (perfAutoState.autoForced && perfAutoState.stableSeconds >= 8) {
      //                 setPerformanceMode(false, { notify: false, syncToggle: true });
      //                 perfAutoState.autoForced = false;
      //                 perfAutoState.stableSeconds = 0;
      //                 showSnackbar('Performance Auto Switch: Stable FPS restored');
      //             }
      //         }

      //         perfAutoState.lastTimestamp = timestamp;
      //         requestAnimationFrame(tick);
      //     };

      //     requestAnimationFrame(tick);
      // }

    // ==========================================
    // 3. GAME & DISPLAY LOGIC
    // ==========================================

    function updateDisplay() {
        // Update Cookie Counters
        const cEl = document.getElementById('cookieCount');
        const cpsEl = document.getElementById('cpsCount');
        if (cEl) cEl.innerText = Math.floor(cookies).toLocaleString();

        let currentCPS = 0;
        Object.values(upgrades).forEach(u => {
            if (u.type === 'auto') currentCPS += u.own * u.cps;
        });
        if (cpsEl) cpsEl.innerText = currentCPS.toLocaleString();

        // Update Upgrade Buttons
        for (const id in upgrades) {
            const u = upgrades[id];
            const btn = document.getElementById(`btn-${id}`);
            const costEl = document.getElementById(`cost-${id}`);
            const ownEl = document.getElementById(`own-${id}`);

            if (costEl) costEl.innerText = u.cost.toLocaleString();
            if (ownEl) ownEl.innerText = u.own;

            if (btn) {
                btn.style.opacity = (cookies >= u.cost) ? "1" : "0.5";
                btn.style.cursor = (cookies >= u.cost) ? "pointer" : "not-allowed";
            }
        }
        updateAchievements();
    }

    function renderUpgrades() {
        const tbody = document.getElementById("upgradeTableBody");
        if (!tbody) return;
        tbody.innerHTML = "";

        for (const [key, u] of Object.entries(upgrades)) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><strong>${u.name}</strong><br><span class="text-muted">+${u.type === 'click' ? u.power + ' Click' : u.cps + ' CPS'}</span></td>
                <td> <span id="cost-${key}">${u.cost}</span></td>
                <td><span id="own-${key}">${u.own}</span></td>
                <td><button id="btn-${key}" class="btn-small">Buy</button></td>
            `;
            // Add listener programmatically to avoid inline HTML string issues
            const btn = tr.querySelector(`#btn-${key}`);
            if(btn) btn.onclick = () => buyUpgrade(key);
            tbody.appendChild(tr);
        }
    }

    function buyUpgrade(id) {
        const u = upgrades[id];
        if (cookies >= u.cost) {
            cookies -= u.cost;
            u.own++;
            if (u.type === 'click') clickPower += u.power;
            u.cost = Math.ceil(u.cost * 1.15);

            // Update achievements
            const upgrader = achievements.find(a => a.id === 'first_upgrade');
            if(upgrader) upgrader.progress = 1;

            const bigSpender = achievements.find(a => a.id === 'ten_upgrades');
            if(bigSpender) bigSpender.progress = Object.values(upgrades).reduce((sum, upgrade) => sum + upgrade.own, 0);

            updateDisplay();
            saveGame();
        } else {
            showSnackbar("Not enough cookies!");
        }
    }

    // ==========================================
    // 4. ACHIEVEMENT SYSTEM
    // ==========================================

    function updateAchievements() {
        const cpsEl = document.getElementById('cpsCount');
        const currentCPS = cpsEl ? parseFloat(cpsEl.innerText.replace(/,/g, '')) : 0;

        const achFirstClick = achievements.find(a => a.id === 'first_click');
        if(achFirstClick) achFirstClick.progress = totalCookiesEarned >= 1 ? 1 : 0;

        const achHundred = achievements.find(a => a.id === 'hundred_cookies');
        if(achHundred) achHundred.progress = Math.min(totalCookiesEarned, 100);

        const achThousand = achievements.find(a => a.id === 'one_thousand');
        if(achThousand) achThousand.progress = Math.min(cookies, 1000);

        const achMaster = achievements.find(a => a.id === 'click_master');
        if(achMaster) achMaster.progress = Math.min(totalCookiesEarned, 1000);

        const achAuto = achievements.find(a => a.id === 'autoclicker');
        if(achAuto) achAuto.progress = Math.min(currentCPS, 10);

        const achConn = achievements.find(a => a.id === 'cookie_connoisseur');
        if(achConn) achConn.progress = Math.min(cookies, 10000);

        achievements.forEach(achievement => {
            if (!achievement.unlocked && achievement.progress >= achievement.goal) {
                achievement.unlocked = true;
                showSnackbar(` Achievement Unlocked: ${getTranslation(achievement.id + '_title')}`);
                saveGame();
            }
        });

        // Only re-render if we are actually looking at achievements to save performance
        const achTab = document.getElementById('achievements');
        const gameTab = document.getElementById('game');
        if ((achTab && !achTab.classList.contains('hidden')) || (gameTab && !gameTab.classList.contains('hidden'))) {
            renderAchievements();
        }
    }

    function renderAchievements() {
        const grids = [document.getElementById('achievementGrid'), document.querySelector('#achievements .achievement-grid')];

        // Filter out nulls and remove duplicates if IDs are same
        const validGrids = [...new Set(grids)].filter(g => g !== null);

        validGrids.forEach(grid => {
            grid.innerHTML = '';
            achievements.forEach(achievement => {
                const card = document.createElement('div');
                card.className = `achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}`;
                const progressPercent = (achievement.progress / achievement.goal) * 100;

                card.innerHTML = `
                  <div class="achievement-icon">${achievement.icon}</div>
                  <div class="achievement-info">
                    <div class="achievement-title">${getTranslation(achievement.id + '_title')}</div>
                    <div class="achievement-desc">${getTranslation(achievement.id + '_desc')}</div>
                    <div class="achievement-progress">
                      <div class="achievement-progress-bar" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="achievement-progress-text">${Math.floor(achievement.progress)}/${achievement.goal}</div>
                  </div>
                  ${achievement.unlocked ? '<div class="achievement-unlocked-badge"></div>' : ''}
                `;
                grid.appendChild(card);
            });
        });

        setupScrollReveal();
    }

    // ==========================================
    // 5. SAVE / LOAD SYSTEM
    // ==========================================

    function saveGame() {
        const data = {
            cookies, totalCookiesEarned, clickPower, upgrades,
            devMode, darkTheme: document.body.classList.contains("dark-theme"),
            achievements, currentLanguage
        };
        storageFacade.local.setItem("lefiSaveV2", JSON.stringify(data));
        // persistStableState('save-game');
    }

    function loadGame() {
        const saved = storageFacade.local.getItem("lefiSaveV2");
        if (saved) {
            try {
                const data = JSON.parse(saved);
                cookies = data.cookies || 0;
                totalCookiesEarned = data.totalCookiesEarned || 0;
                clickPower = data.clickPower || 1;
                devMode = data.devMode || false;
                currentLanguage = data.currentLanguage || 'en';

                if (data.upgrades) {
                    for (const key in data.upgrades) {
                        if (upgrades[key]) {
                            upgrades[key].own = data.upgrades[key].own;
                            upgrades[key].cost = data.upgrades[key].cost;
                        }
                    }
                }
                if (data.achievements) achievements = data.achievements;

                if (data.darkTheme === false) document.body.classList.remove("dark-theme");
                else document.body.classList.add("dark-theme");

                updateLanguageSelector();
            } catch (e) { console.error("Save Corrupt", e); }
        }
        renderUpgrades();
        updateDisplay();
        renderAchievements();
    }

    // ==========================================
    // 6. SYSTEM FUNCTIONS (Terminal, Settings, Lock)
    // ==========================================

    function lockWebsite(manualClick = false) {
        if (devMode) {
            if (manualClick) showSnackbar("Password is currently disabled (Dev Mode).");
            return;
        }
        // Actually implement the overlay logic here if you want it to appear
        // Assuming there is an overlay in HTML (commented out in source but referenced in scripts)
        // If the HTML elements are uncommented, this will work.
        const overlay = document.getElementById("passwordOverlay");
        const passInput = document.getElementById("passwordInput");
        if(overlay && passInput) {
             overlay.classList.add("active");
             overlay.style.display = "flex";
             passInput.focus();
        }
    }

    function executeCommand(val) {
        if (!val) return;
        const normalizedVal = val.trim().toLowerCase();
        const userLayerConfig = getUserLayerConfig();

        if (normalizedVal === 'rt sys-conf pass 18292') {
            activateRootSession();
            return;
        }

        if (userLayerConfig.commandName && normalizedVal === userLayerConfig.commandName.toLowerCase()) {
            showSnackbar(userLayerConfig.commandResponse || 'Custom command executed');
            return;
        }

        if (normalizedVal === "lightmode") {
            document.body.classList.remove("dark-theme");
            showSnackbar("Light mode enabled.");
            saveGame();
        } 
        else if (normalizedVal === "blackmode") {
            document.body.classList.add("dark-theme");
            showSnackbar("Dark mode enabled.");
            saveGame();
        } 
        else if (normalizedVal === "acc unlock") {
            isAccessLocked = false;
            document.body.classList.remove('lock-selection');
            document.body.classList.remove('locked-access');
            showSnackbar("Access Unlocked");
        } 
        else if (normalizedVal === "acc lock") {
            isAccessLocked = true;
            document.body.classList.add('lock-selection');
            document.body.classList.add('locked-access');
            showSnackbar("Access Locked");
        }
        else if (normalizedVal === "show res") {
            const resTab = document.getElementById('resources');
            if (resTab) {
                if (typeof switchTabWithTransitionFn === 'function') {
                    switchTabWithTransitionFn('resources');
                } else {
                    document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
                    resTab.classList.remove('hidden');
                }

                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                if (typeof updateMobileNavIndicatorFn === 'function') {
                    updateMobileNavIndicatorFn({ animate: false });
                }
                showSnackbar("Resources Tab Unlocked");
                homeClickCount = 0;
            }
        }
        // else if (val === "sd pass recog 18x09") {
        //     devMode = true;
        //     showSnackbar("Security Bypass: Password Disabled.");
        //     saveGame();
        // } 
        // else if (val === "sd pass recog 00x00") {
        //     devMode = false;
        //     showSnackbar("Security Active: Password Enabled.");
        //     saveGame();
        // }
        else if (normalizedVal === "wipe-data") {
            if (confirm("Reset everything?")) {
                storageFacade.local.removeItem("lefiSaveV2");
                location.reload();
            }
        } 
        // else if (val === "help") {
        //     showSnackbar("Cmds: lightmode, blackmode, acc unlock/lock, show res, wipe-data");
        // }
        else {
            showSnackbar("Error: Unknown Command");
        }
        
        // persistStableState('command-run');
    }

    function updateLanguageSelector() {
        const enCard = document.getElementById('englishLangCard');
        const zhCard = document.getElementById('chineseLangCard');
        const enCheck = document.getElementById('englishCheck');
        const zhCheck = document.getElementById('chineseCheck');

        if(enCard) enCard.classList.remove('selected');
        if(zhCard) zhCard.classList.remove('selected');
        if(enCheck) enCheck.style.display = 'none';
        if(zhCheck) zhCheck.style.display = 'none';

        if (currentLanguage === 'en') {
            if(enCard) enCard.classList.add('selected');
            if(enCheck) enCheck.style.display = 'block';
        } else {
            if(zhCard) zhCard.classList.add('selected');
            if(zhCheck) zhCheck.style.display = 'block';
        }
        renderAchievements();
        updateTranslations();
    }

    function updateTranslations() {
      const languageChangeText = document.getElementById('languageChangeText');
      if(languageChangeText) {
        languageChangeText.textContent = currentLanguage === 'zh' ? 
            translations['zh'].language_change_text : 
            translations['en'].language_change_text;
      }
    }

    function changeLanguage(lang) {
        if (lang !== currentLanguage) {
            const overlay = document.getElementById('languageChangeOverlay');
            if (overlay) {
                updateTranslations();
                overlay.classList.add('active');
                setTimeout(() => {
                    currentLanguage = lang;
                    updateLanguageSelector();
                    saveGame();
                    setTimeout(() => overlay.classList.remove('active'), 500);
                }, 1500);
            }
        }
    }


    function sanitizeUserLayerInput(value, maxLen = 240) {
        return String(value || '').replace(/[<>]/g, '').trim().slice(0, maxLen);
    }

    function getUserLayerConfig() {
        const raw = storageFacade.local.getItem(ARCH_USER_LAYER_KEY);
        if (!raw) return { ...userLayerDefaults };
        try {
            const parsed = JSON.parse(raw);
            return {
                welcomeTitle: sanitizeUserLayerInput(parsed.welcomeTitle, 80) || userLayerDefaults.welcomeTitle,
                welcomeText: sanitizeUserLayerInput(parsed.welcomeText, 240) || userLayerDefaults.welcomeText,
                accentColor: /^#[0-9a-fA-F]{6}$/.test(parsed.accentColor || '') ? parsed.accentColor : userLayerDefaults.accentColor,
                commandName: sanitizeUserLayerInput(parsed.commandName, 40),
                commandResponse: sanitizeUserLayerInput(parsed.commandResponse, 220),
                layoutDensity: parsed.layoutDensity === 'compact' ? 'compact' : 'comfortable'
            };
        } catch (_err) {
            return { ...userLayerDefaults };
        }
    }

    function addAuditLogEntry(message) {
        const now = new Date().toISOString();
        const current = (() => {
            try { return JSON.parse(storageFacade.local.getItem(ARCH_AUDIT_LOG_KEY) || '[]'); }
            catch (_err) { return []; }
        })();
        current.push(`${now} - ${message}`);
        storageFacade.local.setItem(ARCH_AUDIT_LOG_KEY, JSON.stringify(current.slice(-20)));
    }

    function applyUserLayerConfig() {
        const config = getUserLayerConfig();
        const welcomeTitle = document.querySelector('#home .content-item h1');
        const welcomeText = document.querySelector('#home .content-item p');
        if (welcomeTitle) welcomeTitle.textContent = config.welcomeTitle;
        if (welcomeText) welcomeText.textContent = config.welcomeText;
        document.documentElement.style.setProperty('--accent-color', config.accentColor);
        document.body.classList.toggle('compact-layout', config.layoutDensity === 'compact');
        const auditEl = document.getElementById('rootEditorAuditLog');
        if (auditEl) {
            let logs = [];
            try { logs = JSON.parse(storageFacade.local.getItem(ARCH_AUDIT_LOG_KEY) || '[]'); }
            catch (_err) { logs = []; }
            auditEl.textContent = logs.length ? logs.join('\n') : 'No changes yet.';
        }
    }

    function activateRootSession() {
        isRootSession = true;
        storageFacade.session.setItem(ARCH_ROOT_SESSION_KEY, 'enabled');
        const feedback = document.getElementById('terminalRootFeedback');
        if (feedback) feedback.textContent = 'Root session enabled for this browser tab.';
        addAuditLogEntry('Root session unlocked via terminal command');
        showSnackbar('Root session enabled');
    }

    function setTerminalFeedback(message) {
        const feedback = document.getElementById('terminalRootFeedback');
        if (feedback) feedback.textContent = message;
    }

    function setupRootEditor() {
        const modal = document.getElementById('rootEditorModal');
        const openBtn = document.getElementById('rootEditorOption');
        const closeBtn = document.getElementById('rootEditorCloseBtn');
        const saveBtn = document.getElementById('rootEditorSaveBtn');
        const resetBtn = document.getElementById('rootEditorResetBtn');
        const commandInput = document.getElementById('terminalRootCommandInput');
        const commandBtn = document.getElementById('terminalRootCommandBtn');

        const fillForm = () => {
            const c = getUserLayerConfig();
            const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
            setVal('rootEditorWelcomeTitle', c.welcomeTitle);
            setVal('rootEditorWelcomeText', c.welcomeText);
            setVal('rootEditorAccentColor', c.accentColor);
            setVal('rootEditorCommandName', c.commandName);
            setVal('rootEditorCommandResponse', c.commandResponse);
            setVal('rootEditorLayoutDensity', c.layoutDensity);
        };

        if (commandBtn && commandInput) {
            commandBtn.onclick = () => {
                executeCommand(commandInput.value);
                commandInput.value = '';
            };
            commandInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    executeCommand(commandInput.value);
                    commandInput.value = '';
                }
            };
        }

        if (openBtn) {
            openBtn.onclick = () => {
                if (!isRootSession) {
                    setTerminalFeedback('Run command first');
                    return;
                }
                fillForm();
                applyUserLayerConfig();
                if (modal) {
                    modal.classList.add('active');
                    modal.setAttribute('aria-hidden', 'false');
                }
            };
        }

        if (closeBtn && modal) closeBtn.onclick = () => { modal.classList.remove('active'); modal.setAttribute('aria-hidden', 'true'); };

        if (saveBtn) {
            saveBtn.onclick = () => {
                if (!isRootSession) {
                    setTerminalFeedback('Root session expired or unavailable.');
                    return;
                }
                const nextConfig = {
                    welcomeTitle: sanitizeUserLayerInput(document.getElementById('rootEditorWelcomeTitle')?.value, 80),
                    welcomeText: sanitizeUserLayerInput(document.getElementById('rootEditorWelcomeText')?.value, 240),
                    accentColor: document.getElementById('rootEditorAccentColor')?.value,
                    commandName: sanitizeUserLayerInput(document.getElementById('rootEditorCommandName')?.value, 40).toLowerCase(),
                    commandResponse: sanitizeUserLayerInput(document.getElementById('rootEditorCommandResponse')?.value, 220),
                    layoutDensity: document.getElementById('rootEditorLayoutDensity')?.value === 'compact' ? 'compact' : 'comfortable'
                };
                if (!/^#[0-9a-fA-F]{6}$/.test(nextConfig.accentColor || '')) nextConfig.accentColor = userLayerDefaults.accentColor;
                if (!nextConfig.welcomeTitle) nextConfig.welcomeTitle = userLayerDefaults.welcomeTitle;
                if (!nextConfig.welcomeText) nextConfig.welcomeText = userLayerDefaults.welcomeText;
                storageFacade.local.setItem(ARCH_USER_LAYER_KEY, JSON.stringify(nextConfig));
                addAuditLogEntry(`User layer updated: ${Object.keys(nextConfig).join(', ')}`);
                applyUserLayerConfig();
                setTerminalFeedback('User layer saved and applied.');
            };
        }

        if (resetBtn) {
            resetBtn.onclick = () => {
                storageFacade.local.removeItem(ARCH_USER_LAYER_KEY);
                addAuditLogEntry('User layer reset to defaults');
                applyUserLayerConfig();
                fillForm();
                setTerminalFeedback('User layer reset to defaults.');
            };
        }

        if (modal) {
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    modal.setAttribute('aria-hidden', 'true');
                }
            };
        }
    }

    // ==========================================
    // 7. MAIN INITIALIZATION (Merged DOMContentLoaded)
    // ==========================================

    document.addEventListener("DOMContentLoaded", () => {

        // --- A. LOAD GAME ---
        // loadGame();
        // setupArchWatchdog();
        // setupPerformanceAutoSwitch();

        // --- B. INTRO ANIMATION ---
        const intro = document.getElementById('intro-screen');
        const logo = document.getElementById('intro-logo');
        const loader = document.getElementById('intro-loader');
        const app = document.querySelector('.app-container');

        if (intro) {
            intro.classList.add('active');
            setTimeout(() => {
                if (logo) logo.classList.add('animate');
                setTimeout(() => {
                    if (loader) {
                        loader.classList.remove('hidden');
                        loader.classList.add('show');
                    }
                    setTimeout(() => {
                        if (app) app.classList.add('app-ready');
                        intro.classList.add('fade-out');
                        setTimeout(() => {
                            intro.style.display = 'none';
                            window.dispatchEvent(new Event('resize'));
                        }, 1000);
                    }, 1500); // Wait time
                }, 500);
            }, 100);
        }

        // --- C. NAVIGATION ---
        const navLinks = document.querySelectorAll(".nav-link");
        const sections = document.querySelectorAll(".tab-content");
        const navList = document.querySelector('.nav-list');
        const mobileNavQuery = window.matchMedia('(max-width: 768px)');
        const tabContentFadeDuration = 260;
        activeTabSection = document.querySelector('.tab-content:not(.hidden)') || document.getElementById('home');

        const updateMobileNavIndicator = ({ animate = true } = {}) => {
            if (!navList) return;

            if (!mobileNavQuery.matches) {
                navList.classList.remove('mobile-indicator-ready', 'mobile-indicator-static');
                return;
            }

            const activeLink = navList.querySelector('.nav-link.active');
            if (!activeLink) {
                navList.classList.remove('mobile-indicator-ready');
                return;
            }

            const listRect = navList.getBoundingClientRect();
            const activeRect = activeLink.getBoundingClientRect();

            if (!listRect.width || !activeRect.width) return;

            if (!animate) {
                navList.classList.add('mobile-indicator-static');
            } else {
                navList.classList.remove('mobile-indicator-static');
            }

            navList.style.setProperty('--mobile-active-left', `${Math.round(activeRect.left - listRect.left)}px`);
            navList.style.setProperty('--mobile-active-top', `${Math.round(activeRect.top - listRect.top)}px`);
            navList.style.setProperty('--mobile-active-width', `${Math.round(activeRect.width)}px`);
            navList.style.setProperty('--mobile-active-height', `${Math.round(activeRect.height)}px`);
            navList.classList.add('mobile-indicator-ready');

            if (!animate) {
                requestAnimationFrame(() => navList.classList.remove('mobile-indicator-static'));
            }
        };
        updateMobileNavIndicatorFn = updateMobileNavIndicator;

        const switchTabWithTransition = (targetId) => {
            const nextSection = document.getElementById(targetId);
            if (!nextSection) return;
            if (activeTabSection === nextSection && !nextSection.classList.contains('hidden')) return;

            if (tabTransitionTimer) clearTimeout(tabTransitionTimer);

            sections.forEach(section => {
                if (section === nextSection) return;
                section.classList.add('hidden');
                section.classList.remove('tab-leave', 'tab-enter', 'tab-enter-active');
            });

            nextSection.classList.remove('hidden');
            nextSection.classList.remove('tab-leave');
            nextSection.classList.add('tab-enter');
            activeTabSection = nextSection;

            requestAnimationFrame(() => {
                nextSection.classList.add('tab-enter-active');
            });

            tabTransitionTimer = setTimeout(() => {
                sections.forEach(section => {
                    if (section !== nextSection) {
                        section.classList.add('hidden');
                        section.classList.remove('tab-leave', 'tab-enter', 'tab-enter-active');
                    }
                });
                nextSection.classList.remove('tab-enter', 'tab-enter-active');
                setupScrollReveal();
                tabTransitionTimer = null;
            }, tabContentFadeDuration);
        };
        switchTabWithTransitionFn = switchTabWithTransition;

        navLinks.forEach(link => {
            link.addEventListener("click", () => {
                const targetId = link.dataset.tab;
                navLinks.forEach(n => n.classList.remove("active"));
                link.classList.add("active");
                updateMobileNavIndicator({ animate: true });

                if (targetId) switchTabWithTransition(targetId);

                if (targetId !== 'home') homeClickCount = 0;
                if (targetId === 'achievements' || targetId === 'game') renderAchievements();
            });
        });

        requestAnimationFrame(() => updateMobileNavIndicator({ animate: false }));
        window.addEventListener('resize', () => updateMobileNavIndicator({ animate: false }));
        if (typeof mobileNavQuery.addEventListener === 'function') {
            mobileNavQuery.addEventListener('change', () => updateMobileNavIndicator({ animate: false }));
        } else if (typeof mobileNavQuery.addListener === 'function') {
            mobileNavQuery.addListener(() => updateMobileNavIndicator({ animate: false }));
        }

        // --- D. HOME CLICK (Terminal Trigger) ---
        const homeLink = document.querySelector('.nav-link[data-tab="home"]');
        if (homeLink) {
            homeLink.addEventListener('click', () => {
                if (homeLink.classList.contains('active')) {
                    homeClickCount++;
                    if (homeClickCount >= 10 && !terminalActivated) {
                        homeClickCount = 0;
                        startTerminalSequence();
                        terminalActivated = true;
                    }
                }
            });
        }

        // --- E. COOKIE GAME LOOP ---
        setInterval(saveGame, 30000); // Auto save
        setInterval(() => {
            let cps = 0;
            Object.values(upgrades).forEach(u => { if (u.type === 'auto') cps += u.own * u.cps; });
            if (cps > 0) {
                cookies += cps;
                totalCookiesEarned += cps;
                updateDisplay();
            }
        }, 1000); // Auto click

        const cookieBtn = document.getElementById("cookieBtn");
        if (cookieBtn) {
            cookieBtn.addEventListener("click", () => {
                cookies += clickPower;
                totalCookiesEarned += clickPower;

                const achMaster = achievements.find(a => a.id === 'click_master');
                if(achMaster) achMaster.progress = Math.min(totalCookiesEarned, 1000);

                const achFirst = achievements.find(a => a.id === 'first_click');
                if(achFirst) achFirst.progress = 1;

                updateDisplay();
            });
        }

        // --- F. SETTINGS OVERLAY & NAVIGATION ---
        const settingsOverlay = document.getElementById('settingsOverlay');
        const settingsMainBtn = document.getElementById('settingsMainBtn');
        const closeSettings = document.getElementById('closeSettings');
        const mainMenu = document.getElementById('settingsMainMenu');
        const settingsFadeDuration = 300;
        const settingsShapeDuration = 620;
        let settingsCloseTimer = null;
      let suppressSettingsRippleUntil = 0;

      const isPhoneMode = () => window.matchMedia('(max-width: 768px)').matches;

      const setShapeTransformOrigin = () => {
          if (!settingsMainBtn || !isPhoneMode()) return;
          const btnRect = settingsMainBtn.getBoundingClientRect();
          const shapeRadius = `${Math.min(btnRect.height * 0.35, 14)}px`;

          settingsMainBtn.style.setProperty('--shape-x', `${btnRect.left}px`);
          settingsMainBtn.style.setProperty('--shape-y', `${btnRect.top}px`);
          settingsMainBtn.style.setProperty('--shape-w', `${btnRect.width}px`);
          settingsMainBtn.style.setProperty('--shape-h', `${btnRect.height}px`);
          settingsMainBtn.style.setProperty('--shape-radius', shapeRadius);

          if (settingsOverlay) {
              settingsOverlay.style.setProperty('--shape-x', `${btnRect.left}px`);
              settingsOverlay.style.setProperty('--shape-y', `${btnRect.top}px`);
              settingsOverlay.style.setProperty('--shape-w', `${btnRect.width}px`);
              settingsOverlay.style.setProperty('--shape-h', `${btnRect.height}px`);
              settingsOverlay.style.setProperty('--shape-radius', shapeRadius);
          }
      };


        // Sub-pages
        const subPages = {
            prefs: document.getElementById('pagePrefs'),
            command: document.getElementById('pageCommand'),
            translate: document.getElementById('pageTranslate'),
            update: document.getElementById('pageUpdateCheck')
        };

        const openSettingsOverlay = () => {
            if (!settingsOverlay) return;

            if (settingsCloseTimer) {
                clearTimeout(settingsCloseTimer);
                settingsCloseTimer = null;
            }

          const shouldUseShapeTransform = isPhoneMode() && !document.body.classList.contains('low-spec');
          settingsOverlay.classList.toggle('shape-transform-enabled', shouldUseShapeTransform);

          if (shouldUseShapeTransform) {
              document.body.classList.remove('settings-btn-expanded');
              setShapeTransformOrigin();
              document.body.classList.add('settings-btn-expanding');
          }


            settingsOverlay.classList.remove('closing');
            settingsOverlay.style.display = 'flex';

            if (mainMenu) {
                mainMenu.style.display = 'block';
                mainMenu.classList.remove('hidden-page');
            }
            Object.values(subPages).forEach(p => { if (p) p.classList.add('hidden-page'); });

          requestAnimationFrame(() => {
              settingsOverlay.classList.add('active');
              if (shouldUseShapeTransform) requestAnimationFrame(() => document.body.classList.add('settings-btn-expanded'));
          });
        };

        const closeSettingsOverlay = () => {
            if (!settingsOverlay) return;

            settingsOverlay.classList.remove('active');
            settingsOverlay.classList.add('closing');


          const shouldUseShapeTransform = settingsOverlay.classList.contains('shape-transform-enabled');
          const closeDelay = shouldUseShapeTransform ? settingsShapeDuration : settingsFadeDuration;

          document.body.classList.remove('settings-btn-expanded');
          if (shouldUseShapeTransform) {
              setTimeout(() => document.body.classList.remove('settings-btn-expanding'), settingsFadeDuration);
          } else {
              document.body.classList.remove('settings-btn-expanding');
          }


            if (settingsCloseTimer) clearTimeout(settingsCloseTimer);
            settingsCloseTimer = setTimeout(() => {
                settingsOverlay.style.display = 'none';
                settingsOverlay.classList.remove('closing');
              settingsOverlay.classList.remove('shape-transform-enabled');
              document.body.classList.remove('settings-btn-expanding', 'settings-btn-expanded');
                settingsCloseTimer = null;
            }, closeDelay);
        };

        // Open Settings
        if (settingsMainBtn && settingsOverlay) {
            settingsMainBtn.onclick = (e) => {
                e.preventDefault();
                openSettingsOverlay();
            };
        }

      window.addEventListener('resize', () => {
          if (isPhoneMode()) setShapeTransformOrigin();
      });

        // Close Settings
        if (closeSettings && settingsOverlay) {
            closeSettings.onclick = (e) => {
                e.preventDefault();
                closeSettingsOverlay();
            };
        }

        // Helper to switch pages
        const showSubPage = (pageId) => {
            if(mainMenu) {
                mainMenu.style.display = 'none';
                mainMenu.classList.add('hidden-page');
            }
            if(subPages[pageId]) subPages[pageId].classList.remove('hidden-page');
        };

        const showMainMenu = () => {
            Object.values(subPages).forEach(p => { if(p) p.classList.add('hidden-page'); });
            if(mainMenu) {
                mainMenu.classList.remove('hidden-page');
                mainMenu.style.display = 'block';
            }
        };

        // Bind Sub-Menu Buttons
        const menuBtnMap = {
            'menuSubSettings': 'prefs',
            'menuCommand': 'command',
            'menuTranslate': 'translate',
            'menuUpdateCheck': 'update'
        };

        for(const [btnId, pageKey] of Object.entries(menuBtnMap)) {
            const btn = document.getElementById(btnId);
            if(btn) btn.onclick = (e) => { e.preventDefault(); showSubPage(pageKey); };
        }

        // Bind Back Buttons
        const backBtnMap = {
            'prefsBackBtn': true,
            'commandBackBtn': true,
            'translateBackBtn': true,
            'updateCheckBackBtn': true
        };
        for(const btnId in backBtnMap) {
            const btn = document.getElementById(btnId);
          if(btn) btn.onclick = (e) => {
              e.preventDefault();
              suppressSettingsRippleUntil = performance.now() + 280;
              showMainMenu();
          };
        }

        // --- G. SETTINGS SPECIFIC LOGIC ---

        // 1. Terminal Execution
        const cmdInput = document.getElementById("commandInput");
        const cmdBtn = document.getElementById("commandBtn");
        if (cmdBtn && cmdInput) {
            cmdBtn.onclick = (e) => { e.preventDefault(); executeCommand(cmdInput.value); cmdInput.value = ''; };
            cmdInput.onkeypress = (e) => { if (e.key === 'Enter') { executeCommand(cmdInput.value); cmdInput.value = ''; }};
        }

        // 2. Lock Button
        const menuLock = document.getElementById('menuLock');
        if (menuLock) {
            menuLock.onclick = (e) => {
                e.preventDefault();
                closeSettingsOverlay();
                lockWebsite(true);
            };
        }

        // 3. Language Selection
        const enCard = document.getElementById('englishLangCard');
        const zhCard = document.getElementById('chineseLangCard');
        if(enCard) enCard.onclick = () => changeLanguage('en');
        if(zhCard) zhCard.onclick = () => changeLanguage('zh');

        // 4. Update Check
        const checkUpdateBtn = document.getElementById('checkUpdateBtn');
        if(checkUpdateBtn) {
            checkUpdateBtn.onclick = () => {
                const resultDiv = document.getElementById('updateResult');
                if(resultDiv) {
                    resultDiv.textContent = 'Checking...';
                    resultDiv.className = 'update-result';
                    setTimeout(() => {
                        resultDiv.textContent = 'You are using the latest version: v6';
                        resultDiv.className = 'update-result success';
                    }, 1000);
                }
            };
        }

        // 5. Performance Mode Toggle
        const perfToggle = document.getElementById('perfToggle');
        if (perfToggle) {
            setPerformanceMode(storageFacade.local.getItem('perfMode') === 'enabled', { notify: false, syncToggle: true });
            perfToggle.onchange = () => setPerformanceMode(perfToggle.checked, { notify: true, syncToggle: true });
        }

        const motionToggle = document.getElementById('motionToggle');
        motionController = new MotionController();
        if (motionToggle) {
            motionToggle.checked = storageFacade.local.getItem('motionMode') !== 'disabled';
            motionToggle.onchange = () => {
                if (motionToggleRafPending) return;
                motionToggleRafPending = true;
                requestAnimationFrame(() => {
                    if (motionController) motionController.setEnabled(motionToggle.checked);
                    motionToggleRafPending = false;
                    showSnackbar(motionToggle.checked ? 'Motion Fidelity Enabled' : 'Motion Fidelity Reduced');
                });
            };
        }

        // Performance Alert Banner
        // const perfAlert = document.getElementById('perfAlert');
        // const closeAlertBtn = document.getElementById('closeAlertBtn');
        // if(perfAlert) {
        //     setTimeout(() => perfAlert.classList.add('show'), 1500);
        //     setTimeout(() => perfAlert.classList.remove('show'), 6000);
        //     if(closeAlertBtn) closeAlertBtn.onclick = () => perfAlert.classList.remove('show');
        // }

          // First-time Performance Mode Prompt
          setupFirstTimePerformancePrompt();

        // --- H. TERMINAL OVERLAY LOGIC (The one triggered by 10 clicks) ---
        setupTerminalOverlay();
        setupRootEditor();
        applyUserLayerConfig();
        if (isRootSession) setTerminalFeedback('Root session is active in this tab.');

        // --- I. SAFE MODE LOGIC ---
        setupSafeMode();

        // --- J. MATH CALCULATOR ---
        setupMathCalculator();

        // --- K. PASSWORD SYSTEM (Unlock Button) ---
        const unlockBtn = document.getElementById("unlockBtn");
        const passInput = document.getElementById("passwordInput");
        const passOverlay = document.getElementById("passwordOverlay");
        if(unlockBtn && passInput) {
            unlockBtn.onclick = () => {
                if(passInput.value === "7jxaaa") {
                   if(passOverlay) passOverlay.classList.remove("active");
                } else {
                    showSnackbar("Access Denied");
                    passInput.value = "";
                }
            };
        }

        // --- L. INTERACTION ENHANCEMENTS ---
        if (motionController) motionController.updateProfile();
        setupMouseGlow();
        setupScrollReveal();
        setupButtonRipples();
    });

    function closeFirstTimePerfPrompt() {
        const overlay = document.getElementById('firstTimePerfOverlay');
        if (!overlay) return;

        overlay.classList.add('fade-out');
        window.setTimeout(() => {
            overlay.classList.remove('show', 'fade-out');
            overlay.setAttribute('aria-hidden', 'true');
            overlay.style.display = 'none';
        }, 360);
    }

    function setupFirstTimePerformancePrompt() {
        const overlay = document.getElementById('firstTimePerfOverlay');
        const yesBtn = document.getElementById('firstTimePerfYes');
        const noBtn = document.getElementById('firstTimePerfNo');
        if (!overlay || !yesBtn || !noBtn) return;

        const hasSeenPrompt = storageFacade.local.getItem('perfPromptSeen') === 'true';
        if (hasSeenPrompt) {
            overlay.style.display = 'none';
            return;
        }

        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden', 'false');
        requestAnimationFrame(() => overlay.classList.add('show'));

        yesBtn.onclick = () => {
            setPerformanceMode(true, { notify: true, syncToggle: true });
            storageFacade.local.setItem('perfPromptSeen', 'true');
            closeFirstTimePerfPrompt();
        };

        noBtn.onclick = () => {
            storageFacade.local.setItem('perfPromptSeen', 'true');
            closeFirstTimePerfPrompt();
        };
    }


    // ==========================================
    // 8. MATH CALCULATOR SETUP
    // ==========================================
    function setupMathCalculator() {
        const mathHome = document.getElementById('mathHome');
        // Pages
        const pages = {
            linear1: document.getElementById('linearOneVarPage'),
            quad1: document.getElementById('quadraticOneVarPage'),
            linear2: document.getElementById('linearTwoVarPage')
        };
        // Nav Buttons
        const btns = {
            linear1: document.getElementById('linearOneVarBtn'),
            quad1: document.getElementById('quadraticOneVarBtn'),
            linear2: document.getElementById('linearTwoVarBtn')
        };
        // Back Buttons
        const backBtns = {
            linear1: document.getElementById('linearOneVarBackBtn'),
            quad1: document.getElementById('quadraticOneVarBackBtn'),
            linear2: document.getElementById('linearTwoVarBackBtn')
        };

        const hideAll = () => {
            if(mathHome) mathHome.classList.add('hidden');
            Object.values(pages).forEach(p => { if(p) p.classList.add('hidden'); });
        };

        // Bind Navigation
        for(const [key, btn] of Object.entries(btns)) {
            if(btn) btn.onclick = () => { hideAll(); if(pages[key]) pages[key].classList.remove('hidden'); };
        }
        for(const [key, btn] of Object.entries(backBtns)) {
            if(btn) btn.onclick = () => { hideAll(); if(mathHome) mathHome.classList.remove('hidden'); };
        }

        // Calculation Logic Wrappers
        const safeVal = (id) => { const el = document.getElementById(id); return el ? parseFloat(el.value) : NaN; };
        const setHTML = (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; };
        const clearInputs = (ids) => ids.forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
        const refreshMathJax = () => { if(window.MathJax && window.MathJax.typeset) window.MathJax.typeset(); };
        const fmtNum = (num, precision = 6) => {
            if (!Number.isFinite(num)) return String(num);
            const safeNum = Math.abs(num) < 1e-12 ? 0 : num;
            const nearestInt = Math.round(safeNum);
            if (Math.abs(safeNum - nearestInt) < 1e-10) return String(nearestInt);
            return parseFloat(safeNum.toFixed(precision)).toString();
        };
        const isNearZero = (num) => Math.abs(num) < 1e-10;
        const factorPrefix = (coef) => {
            if (Math.abs(coef - 1) < 1e-10) return '';
            if (Math.abs(coef + 1) < 1e-10) return '-';
            return fmtNum(coef);
        };
        const factorTermFromRoot = (root) => {
            if (isNearZero(root)) return '(x)';
            const absRoot = fmtNum(Math.abs(root));
            return root < 0 ? `(x + ${absRoot})` : `(x - ${absRoot})`;
        };
        const isNearInteger = (num) => Math.abs(num - Math.round(num)) < 1e-10;
        const signedFactors = (num) => {
            const abs = Math.abs(num);
            const factors = new Set();
            for (let i = 1; i <= Math.sqrt(abs); i++) {
                if (abs % i !== 0) continue;
                const j = abs / i;
                factors.add(i);
                factors.add(-i);
                factors.add(j);
                factors.add(-j);
            }
            return [...factors].sort((x, y) => Math.abs(x) - Math.abs(y) || x - y);
        };
        const formatLinearFactor = (A, B) => {
            const aPart = A === 1 ? 'x' : (A === -1 ? '-x' : `${A}x`);
            if (B === 0) return `(${aPart})`;
            return B > 0 ? `(${aPart} + ${Math.abs(B)})` : `(${aPart} - ${Math.abs(B)})`;
        };
        const factoriseIntegerQuadratic = (a, b, c) => {
            if (!isNearInteger(a) || !isNearInteger(b) || !isNearInteger(c)) return null;
            const ai = Math.round(a);
            const bi = Math.round(b);
            const ci = Math.round(c);
            if (ai === 0) return null;

            if (ci === 0) {
                let A = ai;
                let B = bi;
                let sign = '';
                if (A < 0) {
                    A = -A;
                    B = -B;
                    sign = '-';
                }
                return `${sign}(x)${formatLinearFactor(A, B)}`;
            }

            const aFactors = signedFactors(ai);
            const cFactors = signedFactors(ci);

            for (const a1 of aFactors) {
                if (ai % a1 !== 0) continue;
                const a2 = ai / a1;

                for (const b1 of cFactors) {
                    if (ci % b1 !== 0) continue;
                    const b2 = ci / b1;
                    if (a1 * b2 + a2 * b1 !== bi) continue;

                    let f1 = { A: a1, B: b1 };
                    let f2 = { A: a2, B: b2 };
                    let sign = '';

                    if (f1.A < 0) {
                        f1.A *= -1;
                        f1.B *= -1;
                        sign = sign === '-' ? '' : '-';
                    }
                    if (f2.A < 0) {
                        f2.A *= -1;
                        f2.B *= -1;
                        sign = sign === '-' ? '' : '-';
                    }

                    if (Math.abs(f1.A) < Math.abs(f2.A)) {
                        const temp = f1;
                        f1 = f2;
                        f2 = temp;
                    }

                    return `${sign}${formatLinearFactor(f1.A, f1.B)}${formatLinearFactor(f2.A, f2.B)}`;
                }
            }

            return null;
        };

        // 1. Linear One Var
        const l1Calc = document.getElementById('linearOneVarCalcBtn');
        const l1Clear = document.getElementById('linearOneVarClearBtn');
        if(l1Calc) l1Calc.onclick = () => {
            const a = safeVal('linearA'), b = safeVal('linearB'), c = safeVal('linearC');
            if (isNaN(a) || isNaN(b) || isNaN(c)) return showSnackbar("Invalid numbers");

            if (a === 0) {
                if (b === c) {
                    setHTML('linearOneVarResult', "Infinite solutions");
                    setHTML('linearOneVarSteps', "a=0, b=c.");
                } else {
                    setHTML('linearOneVarResult', "No solution");
                    setHTML('linearOneVarSteps', "a=0, b!=c.");
                }
            } else {
                const x = (c - b) / a;
                setHTML('linearOneVarResult', `x = ${x}`);
                setHTML('linearOneVarSteps', 
                    `<div class="step-number">1</div> Given: \\(${a}x + ${b} = ${c}\\)<br>` +
                    `<div class="step-number">2</div> \\(${a}x = ${c - b}\\)<br>` +
                    `<div class="step-number">3</div> \\(x = \\frac{${c - b}}{${a}} = ${x}\\)`
                );
            }
            refreshMathJax();
        };
        if(l1Clear) l1Clear.onclick = () => { clearInputs(['linearA','linearB','linearC']); setHTML('linearOneVarResult',''); setHTML('linearOneVarSteps',''); };

        // 2. Quadratic
        const qCalc = document.getElementById('quadraticOneVarCalcBtn');
        const qFactor = document.getElementById('quadraticOneVarFactorBtn');
        const qClear = document.getElementById('quadraticOneVarClearBtn');
        if(qCalc) qCalc.onclick = () => {
            const a = safeVal('quadA'), b = safeVal('quadB'), c = safeVal('quadC');
            if (isNaN(a) || isNaN(b) || isNaN(c)) return showSnackbar("Invalid numbers");

            if (a === 0) { 
                // Treat as linear
                if(b === 0) setHTML('quadraticOneVarResult', c===0 ? "Infinite" : "No solution");
                else setHTML('quadraticOneVarResult', `Linear: x = ${fmtNum(-c / b)}`);
                setHTML('quadraticOneVarSteps', "a=0, treated as linear.");
            } else {
                const D = b * b - 4 * a * c;
                if (D > 0) {
                    const x1 = (-b + Math.sqrt(D)) / (2 * a);
                    const x2 = (-b - Math.sqrt(D)) / (2 * a);
                    setHTML('quadraticOneVarResult', `x = ${fmtNum(x1)}, x = ${fmtNum(x2)}`);
                    setHTML('quadraticOneVarSteps', `Discriminant  = ${fmtNum(D)} (>0). Two real roots.`);
                } else if (D === 0) {
                    const x = -b / (2 * a);
                    setHTML('quadraticOneVarResult', `x = ${fmtNum(x)}`);
                    setHTML('quadraticOneVarSteps', `Discriminant  = 0. One repeated root.`);
                } else {
                    const rp = -b / (2 * a);
                    const ip = Math.sqrt(Math.abs(D)) / (2 * a);
                    setHTML('quadraticOneVarResult', `x = ${fmtNum(rp)}  ${fmtNum(Math.abs(ip))}i`);
                    setHTML('quadraticOneVarSteps', `Discriminant  = ${fmtNum(D)} (<0). Complex roots.`);
                }
            }
            refreshMathJax();
        };
        if(qFactor) qFactor.onclick = () => {
            const a = safeVal('quadA'), b = safeVal('quadB'), c = safeVal('quadC');
            if (isNaN(a) || isNaN(b) || isNaN(c)) return showSnackbar("Invalid numbers");

            if (a === 0) {
                setHTML('quadraticOneVarResult', "Factorise is only available for quadratic equations (a  0).");
                setHTML('quadraticOneVarSteps', "Entered equation is linear, not quadratic.");
                refreshMathJax();
                return;
            }

            const D = b * b - 4 * a * c;
            const integerFactorised = factoriseIntegerQuadratic(a, b, c);
            if (integerFactorised) {
                setHTML('quadraticOneVarResult', `Factorised: ${integerFactorised}`);
                setHTML('quadraticOneVarSteps', `Integer factorisation found for ${fmtNum(a)}x + ${fmtNum(b)}x + ${fmtNum(c)}.`);
                refreshMathJax();
                return;
            }
            const prefix = factorPrefix(a);

            if (D > 0) {
                const sqrtD = Math.sqrt(D);
                const x1 = (-b + sqrtD) / (2 * a);
                const x2 = (-b - sqrtD) / (2 * a);
                const term1 = factorTermFromRoot(x1);
                const term2 = factorTermFromRoot(x2);
                const core = `${term1}${term2}`;
                const factorised = prefix ? (prefix === '-' ? `-${core}` : `${prefix}${core}`) : core;

                setHTML('quadraticOneVarResult', `Factorised: ${factorised}`);
                setHTML('quadraticOneVarSteps', `Discriminant  = ${fmtNum(D)} (>0), so two real factors.`);
            } else if (D === 0) {
                const x = -b / (2 * a);
                const term = factorTermFromRoot(x);
                const core = `${term}<sup>2</sup>`;
                const factorised = prefix ? (prefix === '-' ? `-${core}` : `${prefix}${core}`) : core;

                setHTML('quadraticOneVarResult', `Factorised: ${factorised}`);
                setHTML('quadraticOneVarSteps', "Discriminant  = 0, so one repeated factor.");
            } else {
                const rp = -b / (2 * a);
                const ip = Math.abs(Math.sqrt(Math.abs(D)) / (2 * a));
                const term1 = `(x - (${fmtNum(rp)} + ${fmtNum(ip)}i))`;
                const term2 = `(x - (${fmtNum(rp)} - ${fmtNum(ip)}i))`;
                const core = `${term1}${term2}`;
                const factorised = prefix ? (prefix === '-' ? `-${core}` : `${prefix}${core}`) : core;

                setHTML('quadraticOneVarResult', `Real factorisation not available. Complex factorised form: ${factorised}`);
                setHTML('quadraticOneVarSteps', `Discriminant  = ${fmtNum(D)} (<0), so roots are complex.`);
            }

            refreshMathJax();
        };
        if(qClear) qClear.onclick = () => { clearInputs(['quadA','quadB','quadC']); setHTML('quadraticOneVarResult',''); setHTML('quadraticOneVarSteps',''); };

        // 3. Linear Two Var
        const l2Calc = document.getElementById('linearTwoVarCalcBtn');
        const l2Clear = document.getElementById('linearTwoVarClearBtn');
        if(l2Calc) l2Calc.onclick = () => {
            const a1 = safeVal('eq1A'), b1 = safeVal('eq1B'), c1 = safeVal('eq1C');
            const a2 = safeVal('eq2A'), b2 = safeVal('eq2B'), c2 = safeVal('eq2C');
            if ([a1,b1,c1,a2,b2,c2].some(isNaN)) return showSnackbar("Invalid numbers");

            const det = a1 * b2 - a2 * b1;
            if (det === 0) {
                 setHTML('linearTwoVarResult', "No unique solution (Parallel or Coincident)");
                 setHTML('linearTwoVarSteps', "Determinant is 0.");
            } else {
                const dx = c1 * b2 - c2 * b1;
                const dy = a1 * c2 - a2 * c1;
                const x = dx / det;
                const y = dy / det;
                setHTML('linearTwoVarResult', `x = ${fmtNum(x)}, y = ${fmtNum(y)}`);
                setHTML('linearTwoVarSteps', `Cramer's Rule: D=${fmtNum(det)}, Dx=${fmtNum(dx)}, Dy=${fmtNum(dy)}`);
            }
            refreshMathJax();
        };
        if(l2Clear) l2Clear.onclick = () => { 
            clearInputs(['eq1A','eq1B','eq1C','eq2A','eq2B','eq2C']); 
            setHTML('linearTwoVarResult',''); setHTML('linearTwoVarSteps',''); 
        };
    }

    function setupMouseGlow() {
        if (mouseGlowBound) return;
        if (document.body.classList.contains('low-spec')) return;
        if (motionController && motionController.profile !== 'full') return;
        if (!window.matchMedia('(pointer: fine)').matches) return;

        const root = document.documentElement;
        let rafId = null;

        window.addEventListener('pointermove', (event) => {
            if (rafId) cancelAnimationFrame(rafId);
            rafId = requestAnimationFrame(() => {
                root.style.setProperty('--mouse-x', `${event.clientX}px`);
                root.style.setProperty('--mouse-y', `${event.clientY}px`);
            });
        }, { passive: true });
        mouseGlowBound = true;
    }

    function setupCardTilt(scope = document) {
        const cards = scope.querySelectorAll('.glass-card, .pref-card, .translate-card, .update-card, .achievement-card, .menu-item-large, .tilt-card');
        cards.forEach(card => {
            card.style.transform = '';
            card.style.removeProperty('--tilt-x');
            card.style.removeProperty('--tilt-y');
            card.classList.remove('tilt-card', 'is-tilting');
            delete card.dataset.tiltBound;
        });
    }

    function setupScrollReveal(scope = document) {
        const targets = scope.querySelectorAll('.tab-content > *, .tab-content .glass-card, .tab-content .math-button, .tab-content .calculator-content, .tab-content .achievement-card');
        if (!targets.length) return;

        if (!('IntersectionObserver' in window)) {
            targets.forEach(target => target.classList.add('revealed'));
            return;
        }

        if (!scrollRevealObserver) {
            scrollRevealObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) return;
                    entry.target.classList.add('revealed');
                    observer.unobserve(entry.target);
                });
            }, {
                threshold: 0.18,
                rootMargin: '0px 0px -8% 0px'
            });
        }

        targets.forEach((target, index) => {
            if (target.dataset.revealBound === '1') return;
            target.dataset.revealBound = '1';
            target.classList.add('scroll-reveal');
            target.style.setProperty('--reveal-delay', `${Math.min(index * 40, 200)}ms`);
            scrollRevealObserver.observe(target);
        });
    }

    function setupButtonRipples() {
        const rippleTargets = document.querySelectorAll('button, .terminal-option, .terminal-back-btn');

        rippleTargets.forEach(target => {
            if (target.dataset.rippleBound === '1') return;
            target.dataset.rippleBound = '1';
            target.classList.add('ripple-host');

            target.addEventListener('pointerdown', (event) => {
                if (event.button !== undefined && event.button !== 0) return;
              if (!target.offsetParent && getComputedStyle(target).position !== 'fixed') return;
              if (target.closest('.hidden-page')) return;
              if (target.closest('#settingsOverlay') && performance.now() < suppressSettingsRippleUntil) return;

                const rect = target.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height) * 1.15;
                const ripple = document.createElement('span');
                ripple.className = 'ripple-wave';

                const x = event.clientX ? event.clientX - rect.left : rect.width / 2;
                const y = event.clientY ? event.clientY - rect.top : rect.height / 2;

                ripple.style.width = `${size}px`;
                ripple.style.height = `${size}px`;
                ripple.style.left = `${x - size / 2}px`;
                ripple.style.top = `${y - size / 2}px`;

                target.appendChild(ripple);
                ripple.addEventListener('animationend', () => ripple.remove());
            });
        });
    }

    function typeTerminalLines(target, lines, onComplete, typingDelay = 24, lineDelay = 180) {
        if (!target) {
            if (typeof onComplete === 'function') onComplete();
            return;
        }

        target.innerHTML = '';
        let lineIndex = 0;

        const typeLine = () => {
            if (lineIndex >= lines.length) {
                if (typeof onComplete === 'function') onComplete();
                return;
            }

            const line = lines[lineIndex];
            const lineEl = document.createElement('div');
            lineEl.className = 'terminal-line';
            target.appendChild(lineEl);

            let charIndex = 0;
            const typeChar = () => {
                lineEl.textContent = line.slice(0, charIndex);
                if (charIndex < line.length) {
                    charIndex++;
                    setTimeout(typeChar, typingDelay);
                } else {
                    lineIndex++;
                    setTimeout(typeLine, lineDelay);
                }
            };

            typeChar();
        };

        typeLine();
    }

    function removeSystemWindow(windowId) {
        const existing = document.getElementById(windowId);
        if (existing) existing.remove();
    }

    function makeSystemWindowDraggable(win, header, titleEl) {
        let dragging = false;
        let pointerId = null;
        let offsetX = 0;
        let offsetY = 0;
        let startClientX = 0;
        let startClientY = 0;
        let moved = false;

        const onPointerMove = (event) => {
            if (!dragging || event.pointerId !== pointerId) return;

            const rect = win.getBoundingClientRect();
            const maxLeft = Math.max(0, window.innerWidth - rect.width);
            const maxTop = Math.max(0, window.innerHeight - rect.height);

            const nextLeft = Math.min(Math.max(0, event.clientX - offsetX), maxLeft);
            const nextTop = Math.min(Math.max(0, event.clientY - offsetY), maxTop);

            win.style.left = `${nextLeft}px`;
            win.style.top = `${nextTop}px`;
            win.style.transform = 'none';

            if (
                !moved &&
                (Math.abs(event.clientX - startClientX) > 3 || Math.abs(event.clientY - startClientY) > 3)
            ) {
                moved = true;
            }
        };

        const onPointerUp = (event) => {
            if (event.pointerId !== pointerId) return;
            dragging = false;
            pointerId = null;

            document.removeEventListener('pointermove', onPointerMove);
            document.removeEventListener('pointerup', onPointerUp);
            document.removeEventListener('pointercancel', onPointerUp);
        };

        header.addEventListener('pointerdown', (event) => {
            if (event.button !== undefined && event.button !== 0) return;
            if (event.target.closest('.system-window-close')) return;

            const rect = win.getBoundingClientRect();
            dragging = true;
            moved = false;
            pointerId = event.pointerId;
            startClientX = event.clientX;
            startClientY = event.clientY;
            offsetX = event.clientX - rect.left;
            offsetY = event.clientY - rect.top;

            if (header.setPointerCapture) {
                try { header.setPointerCapture(pointerId); } catch (_) {}
            }

            document.addEventListener('pointermove', onPointerMove);
            document.addEventListener('pointerup', onPointerUp);
            document.addEventListener('pointercancel', onPointerUp);
        });

        if (titleEl) {
            titleEl.addEventListener('click', (event) => {
                event.stopPropagation();
                if (moved) {
                    moved = false;
                    return;
                }
                win.classList.toggle('collapsed');
            });
        }
    }

    function createSystemWindow(windowId, titleText, extraClass = '') {
        removeSystemWindow(windowId);

        const win = document.createElement('div');
        win.id = windowId;
        win.className = `system-window ${extraClass}`.trim();

        const header = document.createElement('div');
        header.className = 'system-window-header';

        const title = document.createElement('div');
        title.className = 'system-window-title';
        title.textContent = titleText;

        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.className = 'system-window-close';
        closeBtn.setAttribute('aria-label', `Close ${titleText}`);
        closeBtn.textContent = 'x';

        const body = document.createElement('div');
        body.className = 'system-window-body';

        header.appendChild(title);
        header.appendChild(closeBtn);
        win.appendChild(header);
        win.appendChild(body);
        document.body.appendChild(win);

        closeBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            win.remove();
        });

        makeSystemWindowDraggable(win, header, title);

        requestAnimationFrame(() => {
            const rect = win.getBoundingClientRect();
            const left = Math.max(8, Math.round((window.innerWidth - rect.width) / 2));
            const top = Math.max(12, Math.round(window.innerHeight * 0.12));
            win.style.left = `${left}px`;
            win.style.top = `${top}px`;
            win.style.transform = 'none';
        });

        return { win, body };
    }

    function refreshTestModeWindowPerformanceLabel() {
        const perfBtn = document.getElementById('testModePerfBtn');
        if (!perfBtn) return;
        perfBtn.textContent = `Performance Mode (${isPerformanceModeEnabled() ? 'On' : 'Off'})`;
    }

    function showTestModeErrorWindow() {
        removeSystemWindow('testModeErrorWindow');

        const { body } = createSystemWindow('testModeErrorWindow', 'Error', 'error-window');
        const message = document.createElement('p');
        message.className = 'system-window-message';
        message.textContent = 'Test mode only available once Safe Mode is enabled';
        body.appendChild(message);
    }

    function showTestModeWindow() {
        removeSystemWindow('testModeErrorWindow');
        const { body } = createSystemWindow('testModeWindow', 'Test Mode', 'test-mode-window');

        const perfBtn = document.createElement('button');
        perfBtn.type = 'button';
        perfBtn.id = 'testModePerfBtn';
        perfBtn.className = 'system-window-action';
        perfBtn.onclick = () => {
            setPerformanceMode(!isPerformanceModeEnabled(), { notify: false, syncToggle: true });
        };

        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'system-window-action danger';
        clearBtn.textContent = 'Clear Data';
        clearBtn.onclick = () => {
            storageFacade.local.clear();
            refreshTestModeWindowPerformanceLabel();
        };

        const exitBtn = document.createElement('button');
        exitBtn.type = 'button';
        exitBtn.className = 'system-window-action warning';
        exitBtn.textContent = 'Exit Safe Mode';
        exitBtn.onclick = () => {
            disableSafeMode();
        };

        body.appendChild(perfBtn);
        body.appendChild(clearBtn);
        body.appendChild(exitBtn);

        refreshTestModeWindowPerformanceLabel();
        setupButtonRipples();
    }

    // ==========================================
    // 9. TERMINAL & SAFE MODE LOGIC
    // ==========================================
    function startTerminalSequence() {
        const overlay = document.getElementById('terminalOverlay');
        // const perfAlert = document.getElementById('perfAlert');
        if (overlay) overlay.classList.add('active');
        // if (perfAlert) perfAlert.classList.remove('show');

        const tText = document.getElementById('terminalText');
        const tLoader = document.getElementById('terminalLoader');
        const tOptions = document.getElementById('terminalOptions');
        const introLines = [
            '> Initializing ArchOS Terminal...',
            '> Syncing secure profile...',
            '> Loading command modules...',
            '> Terminal ready.'
        ];

        if(tText) tText.style.display = 'block';
        if(tLoader) tLoader.style.display = 'none'; // reset
        if(tOptions) tOptions.style.display = 'none';

        typeTerminalLines(tText, introLines, () => {
            if(tLoader) tLoader.style.display = 'block';
            setTimeout(() => {
                if(tLoader) tLoader.style.display = 'none';
                if(tText) tText.style.display = 'none';
                if(tOptions) tOptions.style.display = 'flex';
            }, 850);
        });
    }

    function setupTerminalOverlay() {
        // Options: Clear, Safe Mode, Test Mode, Exit
        const clearOpt = document.getElementById('clearOption');
        const safeOpt = document.getElementById('safeModeOption');
        const testOpt = document.getElementById('testModeOption');
        const exitOpt = document.getElementById('exitOption');

        // Clear sub-menu
        const clearSub = document.getElementById('terminalClearOptions');
        const clearNow = document.getElementById('clearNowOption');
        const backOpt = document.getElementById('backOption');
        const tOptions = document.getElementById('terminalOptions');
        const tOverlay = document.getElementById('terminalOverlay');

        if(clearOpt) clearOpt.onclick = () => { 
            if(tOptions) tOptions.style.display = 'none';
            if(clearSub) clearSub.style.display = 'flex';
        };

        if(backOpt) backOpt.onclick = () => {
            if(clearSub) clearSub.style.display = 'none';
            if(tOptions) tOptions.style.display = 'flex';
        };

        if(exitOpt) exitOpt.onclick = () => {
            if(tOptions) tOptions.style.display = 'none';
            const tQuit = document.getElementById('terminalQuit');
            const tQLoader = document.getElementById('terminalQuitLoader');
            if(tQuit) tQuit.style.display = 'block';
            if(tQLoader) tQLoader.style.display = 'block';

            setTimeout(() => {
                if(tOverlay) tOverlay.classList.remove('active');
                if(tQuit) tQuit.style.display = 'none';
                if(tQLoader) tQLoader.style.display = 'none';
                terminalActivated = false;
                homeClickCount = 0;
                // Restore perf alert
                const pa = document.getElementById('perfAlert');
                if(pa) pa.classList.add('show');
            }, 2000);
        };

        if(clearNow) clearNow.onclick = () => {
            if(clearSub) clearSub.style.display = 'none';
            const tProc = document.getElementById('terminalProcessing');
            const cdDisp = document.getElementById('countdownDisplay');
            if(tProc) tProc.style.display = 'flex';

            let count = 0;
            if(cdDisp) cdDisp.textContent = `[${count}]`;

            const interval = setInterval(() => {
                count++;
                if(cdDisp) cdDisp.textContent = `[${count}]`;
                if(count >= 4) {
                    clearInterval(interval);
                    storageFacade.local.clear();
                    if(tProc) tProc.style.display = 'none';
                    const tSucc = document.getElementById('terminalSuccess');
                    const tBackBtn = document.getElementById('terminalBackButton');
                    if(tSucc) tSucc.style.display = 'block';
                    if(tBackBtn) {
                        tBackBtn.style.display = 'block';
                        tBackBtn.onclick = () => {
                            tSucc.style.display = 'none';
                            tBackBtn.style.display = 'none';
                            if(tOptions) tOptions.style.display = 'flex';
                        };
                    }
                }
            }, 1000);
        };

        if(safeOpt) safeOpt.onclick = () => {
            if(tOptions) tOptions.style.display = 'none';
            const smOverlay = document.getElementById('safeModeOverlay');
            if(smOverlay) smOverlay.classList.add('active');

            setTimeout(() => {
                if(tOverlay) tOverlay.classList.remove('active');
                terminalActivated = false;
                homeClickCount = 0;
                enableSafeMode();
                if(smOverlay) smOverlay.classList.remove('active');
                const smStatus = document.getElementById('safeModeStatus');
                if(smStatus) smStatus.classList.add('visible');
            }, 2100);
        };

        if(testOpt) testOpt.onclick = () => {
            if (!isSafeModeActive) {
                showTestModeErrorWindow();
                return;
            }

            if(clearSub) clearSub.style.display = 'none';
            if(tOptions) tOptions.style.display = 'none';
            if(tOverlay) tOverlay.classList.remove('active');
            terminalActivated = false;
            homeClickCount = 0;

            const pa = document.getElementById('perfAlert');
            if(pa) pa.classList.add('show');

            showTestModeWindow();
        };
    }

    function setupSafeMode() {
        const smStatus = document.getElementById('safeModeStatus');
        const smDialog = document.getElementById('safeModeDialog');
        const yesBtn = document.getElementById('disableYesBtn');
        const noBtn = document.getElementById('disableNoBtn');

        if(smStatus) {
            smStatus.onclick = () => {
                safeModeClickCount++;
                if(safeModeClickCount >= 3) {
                    if(smDialog) smDialog.classList.add('active');
                    safeModeClickCount = 0;
                }
            };
        }

        if(yesBtn) yesBtn.onclick = () => {
            disableSafeMode();
            if(smDialog) smDialog.classList.remove('active');
        };

        if(noBtn) noBtn.onclick = () => { if(smDialog) smDialog.classList.remove('active'); };

        if(smDialog) smDialog.onclick = (e) => { if(e.target === smDialog) smDialog.classList.remove('active'); };
    }

    function enableSafeMode() {
        isSafeModeActive = true;
        originalPerfMode = isPerformanceModeEnabled() ? 'enabled' : 'disabled';
        // Force safe defaults
        setPerformanceMode(false, { notify: false, syncToggle: true });
        removeSystemWindow('testModeErrorWindow');
    }

    function disableSafeMode() {
        isSafeModeActive = false;
        setPerformanceMode(originalPerfMode === 'enabled', { notify: false, syncToggle: true });

        const smStatus = document.getElementById('safeModeStatus');
        if(smStatus) smStatus.classList.remove('visible');
        const smDialog = document.getElementById('safeModeDialog');
        if(smDialog) smDialog.classList.remove('active');

        removeSystemWindow('testModeWindow');
        removeSystemWindow('testModeErrorWindow');
    }

    // ==========================================
    // 10. GLOBAL SECURITY LISTENERS (Anti-Inspect)
    // ==========================================
    window.addEventListener('keydown', (e) => {
        if (!isAccessLocked) return;
        const target = e.target.tagName.toLowerCase();
        const isInput = target === 'input' || target === 'textarea';

        const isForbidden = (
            e.keyCode === 123 || 
            (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || 
            (e.ctrlKey && e.keyCode === 85)
        );

        if (isForbidden) {
            e.preventDefault();
            showSnackbar(" System Security: Access Denied");
            return false;
        }

        if (!isInput && !isForbidden && e.keyCode !== 116) { // Allow F5
            e.preventDefault();
        }
    });

    document.addEventListener('contextmenu', e => isAccessLocked && e.preventDefault());

    // ==========================================
    // 11. VIEWPORT FIX (Mobile)
    // ==========================================
    (function() {
        function setVh() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        window.addEventListener('load', setVh);
        window.addEventListener('resize', setVh);
        setVh();

        window.addEventListener('resize', () => {
            if (window.innerWidth < 768) {
                const intro = document.getElementById('intro-screen');
                if (intro) intro.onclick = () => { intro.style.display = 'none'; };
            }
        });
    })();

    // Add touch support class
    if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
    }
</script>
  <!-- <div id="perfAlert" class="top-center-alert">
    <span> If you have bad performance, go to <b>Settings > Preferences</b> and enable Performance Mode.</span>
    <button id="closeAlertBtn" class="close-alert-btn" aria-label="Close alert banner" title="Close alert"></button>
  </div> -->
</body>
</html>
